# LINE åœ–ç‰‡è¨Šæ¯å¼·åŒ–å¯¦ä½œè¨ˆåŠƒ

> **ç›®æ¨™**: å¼·åŒ– LINE è¨Šæ¯åŠŸèƒ½ï¼Œæ”¯æ´åœ–ç‰‡æ¥æ”¶ã€é¡¯ç¤ºã€ç¸®åœ–å„ªåŒ–å’Œæ”¾å¤§æŸ¥çœ‹
> **å»ºç«‹æ—¥æœŸ**: 2025-11-19
> **ç‹€æ…‹**: è¦åŠƒä¸­

---

## ğŸ“Š ç¾ç‹€åˆ†æ

### âœ… å·²å¯¦ä½œåŠŸèƒ½
- æ–‡å­—è¨Šæ¯æ”¶ç™¼
- è²¼åœ–è¨Šæ¯æ”¶ç™¼
- å°è©±ç®¡ç†å’Œæœªè®€è¨ˆæ•¸
- è¨Šæ¯åˆ†é å’Œæ‡¶åŠ è¼‰

### âŒ ç¼ºå°‘åŠŸèƒ½
- **åœ–ç‰‡è¨Šæ¯æ¥æ”¶**: Webhook æœªè™•ç† `image` é¡å‹äº‹ä»¶
- **åœ–ç‰‡ä¸‹è¼‰**: æœªå¾ LINE API ä¸‹è¼‰åœ–ç‰‡å…§å®¹
- **åœ–ç‰‡å„²å­˜**: ç„¡æœ¬åœ°/é›²ç«¯å„²å­˜æ©Ÿåˆ¶
- **ç¸®åœ–å„ªåŒ–**: ç„¡è‡ªå‹•ç¸®åœ–ç”Ÿæˆ
- **å‰ç«¯æ¸²æŸ“**: `LineMessages.tsx` ç„¡ IMAGE é¡å‹è™•ç†
- **æ”¾å¤§æŸ¥çœ‹**: ç„¡åœ–ç‰‡ Lightbox åŠŸèƒ½

---

## ğŸ¯ è§£æ±ºæ–¹æ¡ˆæ¶æ§‹

### æ ¸å¿ƒç­–ç•¥: **ç¸®åœ– + åŸåœ–åˆ†é›¢**

```
LINE Bot â†’ Webhook â†’ ä¸‹è¼‰åŸåœ– â†’ ç”Ÿæˆç¸®åœ– â†’ å„²å­˜ â†’ å‰ç«¯æ¸²æŸ“
                                    â†“
                         ç¸®åœ– (100-200KB, å¿«é€Ÿè¼‰å…¥)
                         åŸåœ– (é»æ“Šå¾Œè¼‰å…¥)
```

### å„ªå‹¢
1. **ç¯€çœæµé‡**: åˆ—è¡¨é¡¯ç¤ºç¸®åœ–ï¼Œæ¸›å°‘ 70-90% æ•¸æ“šå‚³è¼¸
2. **æå‡é€Ÿåº¦**: æ‡¶åŠ è¼‰ç¸®åœ–ï¼Œæ»¾å‹•æµæš¢
3. **å„ªåŒ–é«”é©—**: é»æ“Šæ”¾å¤§æ™‚æ‰è¼‰å…¥åŸåœ–
4. **é™ä½æˆæœ¬**: æ¸›å°‘é »å¯¬å’Œå„²å­˜æˆæœ¬

---

## ğŸ—‚ï¸ è³‡æ–™åº«è¨­è¨ˆ

### æ–¹æ¡ˆ A: æ“´å±• `line_messages` è¡¨ï¼ˆæ¨è–¦ï¼‰

åœ¨ç¾æœ‰ `metadata` æ¬„ä½ä¸­å„²å­˜åœ–ç‰‡è³‡è¨Šï¼š

```json
{
  "imageUrl": "/api/line/images/msg_123_original.jpg",
  "thumbnailUrl": "/api/line/images/msg_123_thumb.jpg",
  "originalSize": 2048576,
  "thumbnailSize": 153600,
  "width": 1920,
  "height": 1080,
  "format": "jpeg"
}
```

**å„ªé»**:
- âœ… ä¸éœ€ä¿®æ”¹è³‡æ–™åº«çµæ§‹
- âœ… å‘å¾Œå…¼å®¹ç¾æœ‰è³‡æ–™
- âœ… JSON å½ˆæ€§å„²å­˜å„ç¨®å¾Œè¨­è³‡æ–™

### æ–¹æ¡ˆ B: æ–°å¢ `line_images` è¡¨

```sql
CREATE TABLE line_images (
  id TEXT PRIMARY KEY,
  messageId TEXT NOT NULL,
  organizationId TEXT NOT NULL,
  originalPath TEXT NOT NULL,
  thumbnailPath TEXT NOT NULL,
  originalSize INTEGER,
  thumbnailSize INTEGER,
  width INTEGER,
  height INTEGER,
  format TEXT,
  createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (messageId) REFERENCES line_messages(id) ON DELETE CASCADE
);
```

**å„ªé»**:
- âœ… çµæ§‹æ¸…æ™°ï¼Œä¾¿æ–¼æŸ¥è©¢
- âœ… å¯ç¨ç«‹ç®¡ç†åœ–ç‰‡è³‡æº
- âœ… æ”¯æ´æ‰¹é‡æ¸…ç†å’Œçµ±è¨ˆ

**å»ºè­°**: **ä½¿ç”¨æ–¹æ¡ˆ A**ï¼ˆç°¡å–®å¿«é€Ÿï¼Œé¿å… over-engineeringï¼‰

---

## ğŸ“ æª”æ¡ˆå„²å­˜ç­–ç•¥

### å„²å­˜è·¯å¾‘è¨­è¨ˆ

```
/data/line_images/
  â”œâ”€â”€ {organizationId}/
  â”‚   â”œâ”€â”€ originals/
  â”‚   â”‚   â””â”€â”€ msg_{messageId}_{timestamp}.jpg
  â”‚   â””â”€â”€ thumbnails/
  â”‚       â””â”€â”€ msg_{messageId}_{timestamp}_thumb.jpg
```

### å‘½åè¦å‰‡
- **åŸåœ–**: `msg_{messageId}_{timestamp}.{ext}`
- **ç¸®åœ–**: `msg_{messageId}_{timestamp}_thumb.{ext}`

### ç¸®åœ–è¦æ ¼
- **å°ºå¯¸**: æœ€å¤§å¯¬åº¦ 400pxï¼ˆä¿æŒæ¯”ä¾‹ï¼‰
- **å“è³ª**: JPEG 80% / WebP 85%
- **æ ¼å¼**: å„ªå…ˆ WebPï¼ˆç€è¦½å™¨æ”¯æ´è‰¯å¥½ï¼‰ï¼Œé™ç´š JPEG
- **ç›®æ¨™**: å–®å¼µ 100-200KB

---

## ğŸ—ï¸ å¯¦ä½œéšæ®µ

## Stage 1: å¾Œç«¯ Webhook åœ–ç‰‡æ¥æ”¶è™•ç†

**ç›®æ¨™**: åœ¨ Webhook ä¸­è™•ç† LINE åœ–ç‰‡è¨Šæ¯äº‹ä»¶

**æª”æ¡ˆ**: `server/routes/lineWebhook.js`

**ä»»å‹™**:
1. åœ¨ `handleMessageEvent` æ–°å¢ `case 'image'`
2. å‘¼å« `handleImageMessage` å‡½æ•¸
3. å„²å­˜åˆå§‹è¨Šæ¯è¨˜éŒ„ï¼ˆmessageType: 'IMAGE'ï¼‰

**æ¸¬è©¦æ¨™æº–**:
- [ ] Webhook èƒ½æ¥æ”¶åœ–ç‰‡äº‹ä»¶
- [ ] æ­£ç¢ºè§£æ `message.id` å’Œå…§å®¹ URL
- [ ] è¨Šæ¯è¨˜éŒ„å¯«å…¥è³‡æ–™åº«

**ç‹€æ…‹**: æœªé–‹å§‹

---

## Stage 2: åœ–ç‰‡ä¸‹è¼‰å’Œç¸®åœ–ç”Ÿæˆ

**ç›®æ¨™**: å¾ LINE API ä¸‹è¼‰åŸåœ–ä¸¦ç”Ÿæˆç¸®åœ–

**æª”æ¡ˆ**: `server/services/lineMessaging.js`

**æ–°å¢æ–¹æ³•**:
- `downloadImage(messageId, accessToken)`: å¾ LINE ä¸‹è¼‰åŸåœ–
- `generateThumbnail(imagePath, options)`: ä½¿ç”¨ Sharp ç”Ÿæˆç¸®åœ–
- `saveImageFiles(imageBuffer, messageId, organizationId)`: å„²å­˜æª”æ¡ˆ

**ä¾è³´å¥—ä»¶**:
```bash
npm install sharp
```

**ä»»å‹™**:
1. å¯¦ä½œ `downloadImage` - å‘¼å« LINE Content API
2. å¯¦ä½œ `generateThumbnail` - ä½¿ç”¨ Sharp å£“ç¸®
3. å¯¦ä½œ `saveImageFiles` - æª”æ¡ˆç³»çµ±å¯«å…¥
4. æ›´æ–°è¨Šæ¯è¨˜éŒ„çš„ `metadata`

**æ¸¬è©¦æ¨™æº–**:
- [ ] èƒ½å¾ LINE API ä¸‹è¼‰åœ–ç‰‡
- [ ] ç¸®åœ–å°ºå¯¸ç¬¦åˆè¦æ ¼ï¼ˆâ‰¤ 400px å¯¬ï¼‰
- [ ] æª”æ¡ˆæ­£ç¢ºå„²å­˜åˆ° `/data/line_images/`
- [ ] metadata åŒ…å«å®Œæ•´è·¯å¾‘è³‡è¨Š

**ç‹€æ…‹**: æœªé–‹å§‹

---

## Stage 3: åœ–ç‰‡å„²å­˜å’Œæœå‹™ç«¯é»

**ç›®æ¨™**: æä¾›åœ–ç‰‡å­˜å–çš„ HTTP ç«¯é»

**æª”æ¡ˆ**: `server/routes/line.js`

**æ–°å¢è·¯ç”±**:
```javascript
GET /api/line/images/:filename
```

**ä»»å‹™**:
1. é©—è­‰ä½¿ç”¨è€…æ¬Šé™ï¼ˆå¿…é ˆæ˜¯åŒçµ„ç¹”ï¼‰
2. å¾ `/data/line_images/{orgId}/` è®€å–æª”æ¡ˆ
3. è¨­å®šæ­£ç¢ºçš„ Content-Type å’Œ Cache-Control
4. éŒ¯èª¤è™•ç†ï¼ˆæª”æ¡ˆä¸å­˜åœ¨ã€æ¬Šé™ä¸è¶³ï¼‰

**å®‰å…¨è€ƒé‡**:
- âœ… è·¯å¾‘éæ­·é˜²è­·ï¼ˆç¦æ­¢ `../`ï¼‰
- âœ… æª”æ¡ˆé¡å‹ç™½åå–®ï¼ˆjpg, jpeg, png, webpï¼‰
- âœ… çµ„ç¹”éš”é›¢ï¼ˆé©—è­‰ organizationIdï¼‰

**æ¸¬è©¦æ¨™æº–**:
- [ ] æˆæ¬Šä½¿ç”¨è€…èƒ½æ­£å¸¸å­˜å–åœ–ç‰‡
- [ ] æœªæˆæ¬Šä½¿ç”¨è€…è¿”å› 403
- [ ] ä¸å­˜åœ¨çš„æª”æ¡ˆè¿”å› 404
- [ ] ç€è¦½å™¨æ­£ç¢ºé¡¯ç¤ºåœ–ç‰‡

**ç‹€æ…‹**: æœªé–‹å§‹

---

## Stage 4: å‰ç«¯åœ–ç‰‡æ¸²æŸ“å’Œæ‡¶åŠ è¼‰

**ç›®æ¨™**: åœ¨è¨Šæ¯åˆ—è¡¨ä¸­æ¸²æŸ“åœ–ç‰‡ç¸®åœ–

**æª”æ¡ˆ**: `src/pages/LineMessages.tsx`

**ä»»å‹™**:
1. åœ¨è¨Šæ¯æ¸²æŸ“é‚è¼¯ä¸­æ–°å¢ `IMAGE` é¡å‹åˆ¤æ–·
2. ä½¿ç”¨ `<img>` æ¨™ç±¤æ¸²æŸ“ç¸®åœ–
3. å¯¦ä½œæ‡¶åŠ è¼‰ï¼ˆIntersection Observer æˆ– React Lazy Loadï¼‰
4. è¼‰å…¥å¤±æ•—æ™‚é¡¯ç¤ºä½”ä½ç¬¦

**ç¯„ä¾‹ç¨‹å¼ç¢¼**:
```tsx
{message.messageType === 'IMAGE' && (() => {
  const metadata = message.metadata || {};
  const thumbnailUrl = metadata.thumbnailUrl || metadata.imageUrl;

  return (
    <div className="relative">
      <img
        src={thumbnailUrl}
        alt="åœ–ç‰‡è¨Šæ¯"
        className="max-w-xs rounded-lg cursor-pointer hover:opacity-90 transition"
        loading="lazy"
        onClick={() => handleImageClick(metadata.imageUrl)}
      />
      <div className="absolute bottom-2 right-2 bg-black/50 text-white text-xs px-2 py-1 rounded">
        {formatFileSize(metadata.originalSize)}
      </div>
    </div>
  );
})()}
```

**å„ªåŒ–**:
- ä½¿ç”¨ `loading="lazy"` åŸç”Ÿæ‡¶åŠ è¼‰
- æ·»åŠ éª¨æ¶å±ï¼ˆskeletonï¼‰è¼‰å…¥ç‹€æ…‹
- éŒ¯èª¤åœ–ç‰‡é¡¯ç¤ºæ›¿ä»£æ–‡å­—

**æ¸¬è©¦æ¨™æº–**:
- [ ] åœ–ç‰‡æ­£ç¢ºé¡¯ç¤ºåœ¨è¨Šæ¯æ°£æ³¡ä¸­
- [ ] æ‡¶åŠ è¼‰ç”Ÿæ•ˆï¼ˆæ»¾å‹•æ™‚æ‰è¼‰å…¥ï¼‰
- [ ] è¼‰å…¥å¤±æ•—é¡¯ç¤ºä½”ä½ç¬¦
- [ ] æ¸¸æ¨™æ‡¸åœæœ‰è¦–è¦ºå›é¥‹

**ç‹€æ…‹**: æœªé–‹å§‹

---

## Stage 5: åœ–ç‰‡æ”¾å¤§æª¢è¦–å™¨ (Lightbox)

**ç›®æ¨™**: é»æ“Šåœ–ç‰‡å¾Œå½ˆå‡ºå…¨è¢å¹•æª¢è¦–å™¨

**æª”æ¡ˆ**:
- `src/components/ImageLightbox.tsx`ï¼ˆæ–°å»ºï¼‰
- `src/pages/LineMessages.tsx`ï¼ˆæ•´åˆï¼‰

**åŠŸèƒ½éœ€æ±‚**:
- âœ… é»æ“Šåœ–ç‰‡é–‹å•Ÿ Lightbox
- âœ… é¡¯ç¤ºåŸåœ–ï¼ˆé«˜è§£æåº¦ï¼‰
- âœ… æ”¯æ´éµç›¤ ESC é—œé–‰
- âœ… é»æ“ŠèƒŒæ™¯é—œé–‰
- âœ… é¡¯ç¤ºè¼‰å…¥é€²åº¦
- âœ… æ”¯æ´åœ–ç‰‡ç¸®æ”¾ï¼ˆæ»‘é¼ æ»¾è¼ªï¼‰

**æ¨è–¦æ–¹æ¡ˆ**:

### æ–¹æ¡ˆ A: ä½¿ç”¨ç¾æœ‰ UI çµ„ä»¶ï¼ˆæ¨è–¦ï¼‰
ä½¿ç”¨ Radix UI Dialog + è‡ªè¨‚æ¨£å¼

```bash
# å·²å®‰è£ @radix-ui/react-dialog
```

### æ–¹æ¡ˆ B: è¼•é‡ Lightbox å¥—ä»¶
```bash
npm install yet-another-react-lightbox
```

**å¯¦ä½œç¯„ä¾‹**ï¼ˆæ–¹æ¡ˆ Aï¼‰:
```tsx
import { Dialog, DialogContent } from '@/components/ui/dialog';

export function ImageLightbox({ imageUrl, isOpen, onClose }) {
  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-7xl p-0 bg-black/95">
        <img
          src={imageUrl}
          alt="æ”¾å¤§åœ–ç‰‡"
          className="w-full h-auto max-h-screen object-contain"
        />
      </DialogContent>
    </Dialog>
  );
}
```

**æ¸¬è©¦æ¨™æº–**:
- [ ] é»æ“Šç¸®åœ–é–‹å•Ÿ Lightbox
- [ ] åŸåœ–æ­£ç¢ºè¼‰å…¥é¡¯ç¤º
- [ ] ESC å’ŒèƒŒæ™¯é»æ“Šèƒ½é—œé–‰
- [ ] å¤§åœ–ä¸è®Šå½¢ã€ä¿æŒæ¯”ä¾‹
- [ ] æ”¯æ´è¡Œå‹•è£ç½®è§¸æ§æ‰‹å‹¢

**ç‹€æ…‹**: æœªé–‹å§‹

---

## ğŸ§ª æ¸¬è©¦è¨ˆç•«

### å–®å…ƒæ¸¬è©¦
- [ ] `downloadImage` - æ¨¡æ“¬ LINE API å›æ‡‰
- [ ] `generateThumbnail` - é©—è­‰ç¸®åœ–å°ºå¯¸å’Œæª”æ¡ˆå¤§å°
- [ ] `saveImageFiles` - æª”æ¡ˆå¯«å…¥å’Œè·¯å¾‘æ­£ç¢ºæ€§

### æ•´åˆæ¸¬è©¦
- [ ] ç«¯åˆ°ç«¯åœ–ç‰‡æµç¨‹ï¼ˆWebhook â†’ å„²å­˜ â†’ å‰ç«¯æ¸²æŸ“ï¼‰
- [ ] å¤šçµ„ç¹”éš”é›¢ï¼ˆä¸åŒçµ„ç¹”åœ–ç‰‡ç„¡æ³•äº’è¨ªï¼‰
- [ ] éŒ¯èª¤è™•ç†ï¼ˆç¶²è·¯å¤±æ•—ã€ç£ç¢Ÿæ»¿ã€ç„¡æ•ˆåœ–ç‰‡ï¼‰

### æ•ˆèƒ½æ¸¬è©¦
- [ ] 100 å¼µåœ–ç‰‡è¨Šæ¯çš„è¼‰å…¥é€Ÿåº¦
- [ ] ç¸®åœ–ç”Ÿæˆæ™‚é–“ï¼ˆç›®æ¨™ < 500msï¼‰
- [ ] è¨˜æ†¶é«”ä½¿ç”¨ï¼ˆè™•ç† 10MB åœ–ç‰‡ï¼‰

---

## ğŸ“¦ ç›¸é—œå¥—ä»¶

### éœ€è¦å®‰è£
```bash
npm install sharp  # åœ–ç‰‡è™•ç†ï¼ˆç¸®åœ–ã€å£“ç¸®ï¼‰
```

### å·²å®‰è£å¯ç”¨
- `@radix-ui/react-dialog` - Modal/Lightbox åŸºç¤
- `lucide-react` - åœ–ç¤ºï¼ˆImage, ZoomIn, Download ç­‰ï¼‰

---

## ğŸš€ éƒ¨ç½²è€ƒé‡

### ç£ç¢Ÿç©ºé–“
- **ä¼°ç®—**: æ¯å¼µåœ–ç‰‡å¹³å‡ 2MB åŸåœ– + 150KB ç¸®åœ–
- **1000 å¼µåœ–ç‰‡**: ç´„ 2.15GB
- **å»ºè­°**: å®šæœŸæ¸…ç†è¶…é 90 å¤©çš„åœ–ç‰‡

### æ•ˆèƒ½å„ªåŒ–
1. **CDN**: æœªä¾†å¯è€ƒæ…®ä½¿ç”¨ CloudFlare R2 æˆ– AWS S3
2. **å¿«å–**: è¨­å®š `Cache-Control: max-age=31536000`ï¼ˆåœ–ç‰‡ä¸è®Šï¼‰
3. **å£“ç¸®**: Nginx/Express å•Ÿç”¨ Gzip

### ç›£æ§æŒ‡æ¨™
- åœ–ç‰‡ä¸‹è¼‰å¤±æ•—ç‡
- å¹³å‡ç¸®åœ–ç”Ÿæˆæ™‚é–“
- ç£ç¢Ÿä½¿ç”¨é‡è¶¨å‹¢

---

## ğŸ”§ æœªä¾†æ“´å±•

### çŸ­æœŸï¼ˆ1-2 å€‹æœˆï¼‰
- [ ] æ”¯æ´å½±ç‰‡è¨Šæ¯ï¼ˆç¸®åœ– + æ’­æ”¾å™¨ï¼‰
- [ ] åœ–ç‰‡ç™¼é€åŠŸèƒ½ï¼ˆç®¡ç†å“¡å‚³åœ–ç‰‡çµ¦ç—…æ‚£ï¼‰
- [ ] æ‰¹é‡ä¸‹è¼‰å°è©±åœ–ç‰‡

### ä¸­æœŸï¼ˆ3-6 å€‹æœˆï¼‰
- [ ] é·ç§»è‡³é›²ç«¯å„²å­˜ï¼ˆS3/R2ï¼‰
- [ ] åœ–ç‰‡ OCR æ–‡å­—è¾¨è­˜
- [ ] è‡ªå‹•æ¨™è¨˜æ•æ„Ÿåœ–ç‰‡

### é•·æœŸï¼ˆ6-12 å€‹æœˆï¼‰
- [ ] AI åœ–ç‰‡åˆ†é¡ï¼ˆç—…æ­·ç…§ã€æª¢æŸ¥å ±å‘Šç­‰ï¼‰
- [ ] è‡ªå‹•é—œè¯ç—…æ‚£è¨˜éŒ„
- [ ] DICOM é†«ç™‚å½±åƒæ”¯æ´

---

## ğŸ“ è®Šæ›´è¨˜éŒ„

- **2025-11-19**: åˆç‰ˆè¨ˆåŠƒå»ºç«‹ï¼Œåˆ†æç¾æ³ä¸¦è¦åŠƒ 5 éšæ®µå¯¦ä½œ

---

## âœ… ç°½æ ¸

- **è¦åŠƒè€…**: Claude Code AI
- **å¯©æ ¸è€…**: _å¾…å¡«å¯«_
- **æ ¸å‡†æ—¥æœŸ**: _å¾…å¡«å¯«_
