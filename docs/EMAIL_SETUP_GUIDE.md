# é›»å­éƒµä»¶åŠŸèƒ½è¨­å®šæŒ‡å—

> **ä½¿ç”¨æ–¹æ¡ˆ**: Resendï¼ˆå…è²» 3,000 å°/æœˆï¼‰
> **å»ºç«‹æ—¥æœŸ**: 2025-11-19
> **ç‹€æ…‹**: âœ… å·²å¯¦ä½œå®Œæˆ

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¦½

ç³»çµ±å·²æ•´åˆ Resend éƒµä»¶æœå‹™ï¼Œæ”¯æ´ä»¥ä¸‹åŠŸèƒ½ï¼š

- âœ… **é ç´„æé†’éƒµä»¶** - è‡ªå‹•æé†’ç—…æ‚£é ç´„æ™‚é–“
- âœ… **é ç´„ç¢ºèªéƒµä»¶** - é ç´„æˆåŠŸå¾Œç«‹å³ç™¼é€ç¢ºèª
- âœ… **é ç´„å–æ¶ˆé€šçŸ¥** - é ç´„å–æ¶ˆæ™‚é€šçŸ¥ç—…æ‚£
- âœ… **ä¸€èˆ¬é€šçŸ¥éƒµä»¶** - è‡ªè¨‚æ¨™é¡Œå’Œå…§å®¹çš„é€šçŸ¥

---

## ğŸš€ å¿«é€Ÿé–‹å§‹ï¼ˆ5 åˆ†é˜è¨­å®šï¼‰

### Step 1: è¨»å†Š Resend å¸³è™Ÿ

1. å‰å¾€ [https://resend.com/signup](https://resend.com/signup)
2. ä½¿ç”¨ Email æˆ– GitHub å¸³è™Ÿè¨»å†Š
3. å®Œæˆ Email é©—è­‰

### Step 2: å»ºç«‹ API Key

1. ç™»å…¥å¾Œé€²å…¥ [API Keys](https://resend.com/api-keys) é é¢
2. é»æ“Šã€ŒCreate API Keyã€
3. è¼¸å…¥åç¨±ï¼ˆå¦‚ï¼š`Patient CRM Production`ï¼‰
4. é¸æ“‡æ¬Šé™ï¼š**Sending access**
5. é»æ“Šã€ŒCreateã€ä¸¦**ç«‹å³è¤‡è£½ API Key**ï¼ˆåªé¡¯ç¤ºä¸€æ¬¡ï¼ï¼‰

### Step 3: è¨­å®šç’°å¢ƒè®Šæ•¸

åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„çš„ `.env` æª”æ¡ˆä¸­æ–°å¢ï¼š

```bash
# Resend éƒµä»¶æœå‹™
RESEND_API_KEY=re_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# å¯„ä»¶è€…éƒµç®±ï¼ˆæš«æ™‚ä½¿ç”¨ Resend æä¾›çš„æ¸¬è©¦éƒµç®±ï¼‰
EMAIL_FROM=onboarding@resend.dev
```

**æš«æ™‚æ¸¬è©¦éšæ®µ**ï¼šä½¿ç”¨ `onboarding@resend.dev` å¯ä»¥ç«‹å³æ¸¬è©¦ï¼Œä½†åªèƒ½ç™¼é€åˆ°è‡ªå·±çš„éƒµç®±ã€‚

### Step 4: é‡å•Ÿä¼ºæœå™¨

```bash
npm run dev
```

âœ… å®Œæˆï¼ç¾åœ¨å¯ä»¥æ¸¬è©¦éƒµä»¶åŠŸèƒ½äº†ã€‚

---

## ğŸŒ ä½¿ç”¨è‡ªè¨‚ç¶²åŸŸï¼ˆæ­£å¼ç’°å¢ƒï¼‰

### ç‚ºä»€éº¼éœ€è¦è‡ªè¨‚ç¶²åŸŸï¼Ÿ

- ä½¿ç”¨ `onboarding@resend.dev` åªèƒ½ç™¼é€åˆ°æ‚¨è‡ªå·±çš„éƒµç®±
- è‡ªè¨‚ç¶²åŸŸå¯ä»¥ç™¼é€çµ¦ä»»ä½•ç—…æ‚£
- æå‡å°ˆæ¥­å½¢è±¡ï¼ˆå¦‚ `noreply@yourcompany.com`ï¼‰

### Step 1: åœ¨ Resend æ–°å¢ç¶²åŸŸ

1. é€²å…¥ [Domains](https://resend.com/domains) é é¢
2. é»æ“Šã€ŒAdd Domainã€
3. è¼¸å…¥æ‚¨çš„ç¶²åŸŸï¼ˆå¦‚ `yourcompany.com`ï¼‰

### Step 2: è¨­å®š DNS è¨˜éŒ„ï¼ˆåœ¨ Cloudflareï¼‰

Resend æœƒæä¾› 3 ç­† DNS è¨˜éŒ„ï¼Œæ‚¨éœ€è¦åœ¨ Cloudflare æ–°å¢ï¼š

#### ğŸ“‹ éœ€è¦æ–°å¢çš„è¨˜éŒ„

| é¡å‹ | åç¨± | å…§å®¹ | TTL |
|------|------|------|-----|
| **TXT** | `yourcompany.com` | `v=spf1 include:amazonses.com ~all` | Auto |
| **CNAME** | `resend._domainkey` | `resend._domainkey.resend.com` | Auto |
| **CNAME** | `resend2._domainkey` | `resend2._domainkey.resend.com` | Auto |

#### ğŸ–¥ï¸ Cloudflare æ“ä½œæ­¥é©Ÿ

1. ç™»å…¥ [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. é¸æ“‡æ‚¨çš„ç¶²åŸŸ
3. é€²å…¥ã€ŒDNSã€â†’ã€ŒRecordsã€
4. é»æ“Šã€ŒAdd recordã€ï¼Œä¾åºæ–°å¢ä¸Šè¿° 3 ç­†è¨˜éŒ„
5. **é‡è¦**: Proxy status è¨­ç‚ºã€ŒDNS onlyã€ï¼ˆç°è‰²é›²æœµï¼‰

### Step 3: é©—è­‰ç¶²åŸŸ

1. å›åˆ° Resend çš„ Domains é é¢
2. é»æ“Šã€ŒVerify DNS Recordsã€
3. ç­‰å¾…å¹¾åˆ†é˜ï¼ˆDNS å‚³æ’­æ™‚é–“ï¼‰
4. çœ‹åˆ° âœ… ç¶ è‰²å‹¾å‹¾è¡¨ç¤ºé©—è­‰æˆåŠŸ

### Step 4: æ›´æ–°ç’°å¢ƒè®Šæ•¸

```bash
# æ”¹ç”¨æ‚¨çš„è‡ªè¨‚ç¶²åŸŸ
EMAIL_FROM=noreply@yourcompany.com
```

---

## ğŸ”§ API ä½¿ç”¨æ–¹å¼

### æª¢æŸ¥éƒµä»¶æœå‹™ç‹€æ…‹

```bash
GET /api/email/status
```

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "data": {
    "enabled": true,
    "sender": "noreply@yourcompany.com"
  }
}
```

### ç™¼é€ç”¨æˆ¶å¸³è™Ÿå¯†ç¢¼ï¼ˆæ–°å»ºè¨ºæ‰€ç”¨æˆ¶æ™‚è‡ªå‹•ç™¼é€ï¼‰

```bash
POST /api/email/send/user-credentials
Content-Type: application/json
Authorization: Bearer {your_jwt_token}

{
  "to": "user@example.com",
  "userName": "ç‹é†«å¸«",
  "username": "clinic_admin",
  "password": "TempPass123",
  "organizationName": "ç‹æ°è¨ºæ‰€",
  "loginUrl": "https://your-domain.com/login"
}
```

**æ³¨æ„äº‹é …**:

- æ­¤ API æœƒåœ¨å‰µå»ºæ–°ç”¨æˆ¶æ™‚è‡ªå‹•èª¿ç”¨ï¼ˆéœ€å•Ÿç”¨éƒµä»¶æœå‹™ï¼‰
- éƒµä»¶åŒ…å«æ˜æ–‡å¯†ç¢¼ï¼Œè«‹æé†’ç”¨æˆ¶é¦–æ¬¡ç™»å…¥å¾Œç«‹å³ä¿®æ”¹
- `loginUrl` åƒæ•¸å¯é¸ï¼Œé è¨­ç‚ºç³»çµ±ç™»å…¥é é¢
- åƒ…ç”¨æ–¼è¨ºæ‰€å®¢æˆ¶ï¼ˆadmin/user è§’è‰²ï¼‰ï¼Œä¸ç”¨æ–¼ç—…æ‚£

### ç™¼é€é ç´„æé†’

```bash
POST /api/email/send/appointment-reminder
Content-Type: application/json
Authorization: Bearer {your_jwt_token}

{
  "to": "patient@example.com",
  "patientName": "ç‹å°æ˜",
  "date": "2025-11-25",
  "time": "14:30",
  "type": "å®šæœŸæª¢æŸ¥",
  "notes": "è«‹æ”œå¸¶å¥ä¿å¡"
}
```

### ç™¼é€é ç´„ç¢ºèª

```bash
POST /api/email/send/appointment-confirmation
Content-Type: application/json
Authorization: Bearer {your_jwt_token}

{
  "to": "patient@example.com",
  "patientName": "ç‹å°æ˜",
  "date": "2025-11-25",
  "time": "14:30",
  "type": "å®šæœŸæª¢æŸ¥"
}
```

### ç™¼é€é ç´„å–æ¶ˆé€šçŸ¥

```bash
POST /api/email/send/appointment-cancellation
Content-Type: application/json
Authorization: Bearer {your_jwt_token}

{
  "to": "patient@example.com",
  "patientName": "ç‹å°æ˜",
  "date": "2025-11-25",
  "time": "14:30",
  "type": "å®šæœŸæª¢æŸ¥",
  "reason": "é†«å¸«è‡¨æ™‚æœ‰äº‹"
}
```

### ç™¼é€ä¸€èˆ¬é€šçŸ¥

```bash
POST /api/email/send/notification
Content-Type: application/json
Authorization: Bearer {your_jwt_token}

{
  "to": "patient@example.com",
  "patientName": "ç‹å°æ˜",
  "title": "å¥åº·å ±å‘Šå·²å®Œæˆ",
  "message": "<p>æ‚¨çš„å¥åº·æª¢æŸ¥å ±å‘Šå·²å®Œæˆï¼Œè«‹è‡³è¨ºæ‰€é ˜å–ã€‚</p>"
}
```

---

## ğŸ’¡ è‡ªå‹•é ç´„æé†’åŠŸèƒ½

### âš™ï¸ ç³»çµ±å·²å…§å»ºè‡ªå‹•æé†’

ç³»çµ±å·²å…§å»ºå®šæ™‚ä»»å‹™æœå‹™ï¼ˆä½¿ç”¨ node-cronï¼‰ï¼Œæ¯å¤©æ—©ä¸Š 9:00 è‡ªå‹•æª¢æŸ¥æ˜æ—¥é ç´„ä¸¦ç™¼é€æé†’ã€‚

**ç‰¹è‰²**ï¼š

- âœ… æ¯æ—¥è‡ªå‹•åŸ·è¡Œï¼Œç„¡éœ€æ‰‹å‹•æ“ä½œ
- âœ… å¤šçµ„ç¹”æ”¯æ´ï¼Œè‡ªå‹•è™•ç†æ‰€æœ‰å•Ÿç”¨ä¸­çš„è¨ºæ‰€
- âœ… æ™ºèƒ½é¸æ“‡æé†’æ–¹å¼ï¼ˆEmail / LINEï¼‰
- âœ… å®Œæ•´çš„æ—¥èªŒè¨˜éŒ„å’ŒéŒ¯èª¤è™•ç†
- âœ… çµ±è¨ˆå ±å‘Šï¼ˆç™¼é€æˆåŠŸ/å¤±æ•—æ•¸é‡ï¼‰

### ğŸ“‹ å¦‚ä½•å•Ÿç”¨/åœç”¨æé†’

å‰å¾€**ç³»çµ±è¨­å®š** > **æ•´åˆè¨­å®š**é é¢ï¼š

1. **Email é ç´„æé†’**ï¼š
   - é–‹é—œåˆ‡æ›å³å¯å•Ÿç”¨/åœç”¨
   - éœ€è¦å…ˆè¨­å®š Resend API Key
   - æœƒè‡ªå‹•ç™¼é€çµ¦æœ‰ Email çš„ç—…æ‚£

2. **LINE é ç´„æé†’**ï¼š
   - é–‹é—œåˆ‡æ›å³å¯å•Ÿç”¨/åœç”¨
   - éœ€è¦å…ˆå®Œæˆ LINE Channel è¨­å®š
   - æœƒè‡ªå‹•ç™¼é€çµ¦æœ‰ç¶å®š LINE çš„ç—…æ‚£

**æç¤º**ï¼šå¯ä»¥åŒæ™‚å•Ÿç”¨å¤šç¨®æé†’æ–¹å¼ï¼Œç³»çµ±æœƒæ ¹æ“šç—…æ‚£è³‡æ–™è‡ªå‹•é¸æ“‡å¯ç”¨çš„ç®¡é“ã€‚

### ğŸ” è‡ªå‹•æé†’é‹ä½œæµç¨‹

```text
æ¯å¤©æ—©ä¸Š 09:00
    â†“
æª¢æŸ¥æ‰€æœ‰å•Ÿç”¨ä¸­çš„çµ„ç¹”
    â†“
è®€å–çµ„ç¹”çš„é€šçŸ¥è¨­å®š
    â†“
æŸ¥è©¢è©²çµ„ç¹”æ˜å¤©çš„é ç´„
    â†“
æ ¹æ“šè¨­å®šæ±ºå®šç™¼é€æ–¹å¼ï¼š
  - Email æé†’å·²å•Ÿç”¨ + ç—…æ‚£æœ‰ Email â†’ ç™¼é€ Email
  - LINE æé†’å·²å•Ÿç”¨ + ç—…æ‚£æœ‰ç¶å®š LINE â†’ ç™¼é€ LINE è¨Šæ¯
    â†“
è¨˜éŒ„çµ±è¨ˆè³‡è¨Šä¸¦è¼¸å‡ºæ—¥èªŒ
```

### ğŸ“Š æ—¥èªŒç¯„ä¾‹

ç³»çµ±æœƒåœ¨ä¼ºæœå™¨ console è¼¸å‡ºè©³ç´°æ—¥èªŒï¼š

```text
ğŸ• å•Ÿå‹•å®šæ™‚ä»»å‹™æœå‹™...
âœ… å®šæ™‚ä»»å‹™å·²å•Ÿå‹•ï¼š
   - æ¯æ—¥ 09:00 ç™¼é€æ˜æ—¥é ç´„æé†’

ğŸ“… é–‹å§‹æª¢æŸ¥æ˜æ—¥é ç´„ä¸¦ç™¼é€æé†’...
ğŸ“† æŸ¥è©¢æ—¥æœŸ: 2025-11-20 çš„é ç´„
ğŸ¥ æ‰¾åˆ° 3 å€‹å•Ÿç”¨ä¸­çš„çµ„ç¹”

ğŸ” è™•ç†çµ„ç¹”: ç‹æ°è¨ºæ‰€
   Email æé†’: âœ…
   LINE æé†’: âœ…
   æ‰¾åˆ° 5 ç­†é ç´„

   âœ‰ï¸  å·²ç™¼é€ Email æé†’è‡³: patient1@example.com (ç‹å°æ˜)
   ğŸ“± [TODO] æ‡‰ç™¼é€ LINE æé†’è‡³: æå°è¯
   âš ï¸  å¼µä¸‰ æœªè¨­å®š Emailï¼Œè·³é Email æé†’

ğŸ“Š æé†’ç™¼é€çµ±è¨ˆï¼š
   ç¸½é ç´„æ•¸: 15
   Email å·²ç™¼é€: 10
   LINE å·²ç™¼é€: 8
   ç™¼é€å¤±æ•—: 0
âœ… æ˜æ—¥é ç´„æé†’è™•ç†å®Œæˆ
```

### ğŸ› ï¸ æŠ€è¡“ç´°ç¯€

å®šæ™‚ä»»å‹™æœå‹™ä½æ–¼ï¼š`server/services/cronJobs.js`

æ ¸å¿ƒåŠŸèƒ½ï¼š

- ä½¿ç”¨ `node-cron` æ’ç¨‹åŸ·è¡Œ
- è‡ªå‹•å•Ÿå‹•ï¼ˆä¼ºæœå™¨å•Ÿå‹•æ™‚å³è¼‰å…¥ï¼‰
- æŸ¥è©¢ `organizations.settings.notifications` è¨­å®š
- å¤šç§Ÿæˆ¶éš”é›¢ï¼ˆæ¯å€‹çµ„ç¹”ç¨ç«‹è™•ç†ï¼‰
- éé˜»å¡å¼ç™¼é€ï¼ˆä½¿ç”¨ async/awaitï¼‰

### âš™ï¸ è‡ªè¨‚æ’ç¨‹æ™‚é–“

å¦‚éœ€ä¿®æ”¹æé†’ç™¼é€æ™‚é–“ï¼Œç·¨è¼¯ `server/services/cronJobs.js`ï¼š

```javascript
// é è¨­ï¼šæ¯å¤©æ—©ä¸Š 9:00
cron.schedule('0 9 * * *', async () => {
  await sendTomorrowAppointmentReminders();
});

// ç¯„ä¾‹ï¼šæ”¹ç‚ºæ¯å¤©æ—©ä¸Š 8:30
cron.schedule('30 8 * * *', async () => {
  await sendTomorrowAppointmentReminders();
});

// Cron æ ¼å¼èªªæ˜ï¼š
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åˆ†é˜ (0 - 59)
// â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å°æ™‚ (0 - 23)
// â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ—¥ (1 - 31)
// â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æœˆ (1 - 12)
// â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ˜ŸæœŸ (0 - 6, 0=æ˜ŸæœŸæ—¥)
// â”‚ â”‚ â”‚ â”‚ â”‚
// * * * * *
```

### ğŸ§ª æ‰‹å‹•æ¸¬è©¦æé†’åŠŸèƒ½

å¯ä»¥æ‰‹å‹•è§¸ç™¼æé†’ç™¼é€ï¼ˆç”¨æ–¼æ¸¬è©¦ï¼‰ï¼š

```javascript
// åœ¨ä¼ºæœå™¨ console æˆ– Node.js REPL ä¸­åŸ·è¡Œ
const { sendTomorrowAppointmentReminders } = require('./server/services/cronJobs');
await sendTomorrowAppointmentReminders();
```

æˆ–ä½¿ç”¨æ¸¬è©¦ç”¨çš„æ¯åˆ†é˜æ’ç¨‹ï¼ˆè¨˜å¾—æ¸¬è©¦å¾Œé—œé–‰ï¼‰ï¼š

```javascript
// åœ¨ cronJobs.js ä¸­å–æ¶ˆè¨»è§£ä»¥ä¸‹ç¨‹å¼ç¢¼
cron.schedule('* * * * *', async () => {
  console.log('ğŸ§ª [æ¸¬è©¦] æª¢æŸ¥æ˜æ—¥é ç´„...');
  await sendTomorrowAppointmentReminders();
});
```

---

## ğŸ’¡ æ‰‹å‹•æ•´åˆå»ºè­°

### é ç´„å»ºç«‹æ™‚ç™¼é€ç¢ºèªéƒµä»¶

æ‚¨ä¹Ÿå¯ä»¥åœ¨é ç´„å»ºç«‹æ™‚ç«‹å³ç™¼é€ç¢ºèªéƒµä»¶ï¼ˆéå®šæ™‚ä»»å‹™ï¼‰ã€‚

åœ¨é ç´„å»ºç«‹ API ä¸­æ–°å¢ï¼š

```javascript
// åœ¨ server/routes/appointments.js
router.post('/', async (req, res) => {
  // ... å»ºç«‹é ç´„é‚è¼¯ ...

  // ç™¼é€ç¢ºèªéƒµä»¶
  if (patient.email) {
    await EmailService.sendAppointmentConfirmation({
      to: patient.email,
      patientName: patient.name,
      date: appointment.date,
      time: appointment.time,
      type: appointment.type
    });
  }

  res.json({ success: true, data: appointment });
});
```

---

## ğŸ“Š ä½¿ç”¨é™åˆ¶

### Resend å…è²»æ–¹æ¡ˆ

| é …ç›® | é™åˆ¶ |
|------|------|
| **æ¯æœˆç™¼é€é‡** | 3,000 å° |
| **æ¯æ—¥ç™¼é€é‡** | 100 å° |
| **API è«‹æ±‚** | ç„¡é™åˆ¶ |
| **ç¶²åŸŸæ•¸é‡** | 1 å€‹ |

### å¦‚ä½•ç›£æ§ç”¨é‡ï¼Ÿ

1. ç™»å…¥ [Resend Dashboard](https://resend.com/overview)
2. æŸ¥çœ‹ã€ŒUsageã€å€å¡Š
3. å¯ä»¥çœ‹åˆ°ç•¶æœˆå·²ç™¼é€æ•¸é‡

### è¶…éé™åˆ¶æ€éº¼è¾¦ï¼Ÿ

- **çŸ­æœŸæ–¹æ¡ˆ**: å‡ç´šåˆ° Pro æ–¹æ¡ˆï¼ˆ$20/æœˆï¼Œ50,000 å°ï¼‰
- **é•·æœŸæ–¹æ¡ˆ**: æ ¹æ“šå¯¦éš›éœ€æ±‚é¸æ“‡åˆé©æ–¹æ¡ˆ

---

## ğŸ” æ¸¬è©¦æ–¹å¼

### æ–¹æ³• 1: ä½¿ç”¨ Postman/Insomnia

1. è¨­å®š `Authorization: Bearer {token}`
2. ç™¼é€ POST è«‹æ±‚åˆ° `/api/email/send/appointment-reminder`
3. æª¢æŸ¥æ‚¨çš„éƒµç®±

### æ–¹æ³• 2: ä½¿ç”¨ curl

```bash
curl -X POST http://localhost:3001/api/email/send/appointment-reminder \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{
    "to": "your-email@example.com",
    "patientName": "æ¸¬è©¦æ‚£è€…",
    "date": "2025-11-25",
    "time": "14:30",
    "type": "æ¸¬è©¦é ç´„"
  }'
```

---

## ğŸ› å¸¸è¦‹å•é¡Œ

### Q1: ç‚ºä»€éº¼éƒµä»¶æ²’æœ‰ç™¼é€ï¼Ÿ

**æª¢æŸ¥æ¸…å–®**:
- [ ] `RESEND_API_KEY` æ˜¯å¦æ­£ç¢ºè¨­å®šï¼Ÿ
- [ ] ç’°å¢ƒè®Šæ•¸æ˜¯å¦å·²é‡æ–°è¼‰å…¥ï¼Ÿï¼ˆé‡å•Ÿä¼ºæœå™¨ï¼‰
- [ ] æ”¶ä»¶è€…éƒµç®±æ˜¯å¦æ­£ç¢ºï¼Ÿ
- [ ] æª¢æŸ¥ä¼ºæœå™¨ log æ˜¯å¦æœ‰éŒ¯èª¤è¨Šæ¯

### Q2: éƒµä»¶é€²å…¥åƒåœ¾éƒµä»¶æ€éº¼è¾¦ï¼Ÿ

**è§£æ±ºæ–¹æ³•**:
1. ä½¿ç”¨è‡ªè¨‚ç¶²åŸŸï¼ˆä¸è¦ç”¨ `onboarding@resend.dev`ï¼‰
2. æ­£ç¢ºè¨­å®š SPF å’Œ DKIMï¼ˆDNS è¨˜éŒ„ï¼‰
3. é¿å…ä½¿ç”¨éå¤šä¿ƒéŠ·è©å½™
4. å»ºè­°ç—…æ‚£å°‡æ‚¨çš„éƒµç®±åŠ å…¥é€šè¨ŠéŒ„

### Q3: Cloudflare Email Routing å¯ä»¥ç”¨ä¾†ç™¼ä¿¡å—ï¼Ÿ

**ç­”æ¡ˆ**: ä¸è¡Œã€‚

- **Cloudflare Email Routing** åªèƒ½ã€Œæ¥æ”¶ã€å’Œã€Œè½‰å¯„ã€éƒµä»¶
- **ç„¡æ³•ä¸»å‹•ç™¼é€** éƒµä»¶çµ¦ç—…æ‚£
- æ‰€ä»¥éœ€è¦ä½¿ç”¨ Resend ç­‰ç¬¬ä¸‰æ–¹æœå‹™

ä½†æ‚¨å¯ä»¥ä¿ç•™ Cloudflare Email Routing æ¥æ”¶ç—…æ‚£å›ä¿¡ï¼

---

## ğŸ¨ éƒµä»¶ç¯„æœ¬è‡ªè¨‚

æ‰€æœ‰éƒµä»¶ç¯„æœ¬éƒ½åœ¨ `server/services/emailService.js` ä¸­ã€‚

### ä¿®æ”¹æ¨£å¼

ç·¨è¼¯ `<style>` æ¨™ç±¤å…§çš„ CSSï¼š

```javascript
const html = `
  <style>
    .header { background: #YOUR_COLOR; }  /* ä¿®æ”¹ä¸»è‰²èª¿ */
    .button { background: #YOUR_COLOR; }  /* ä¿®æ”¹æŒ‰éˆ•é¡è‰² */
  </style>
`;
```

### æ–°å¢è‡ªè¨‚éƒµä»¶é¡å‹

åœ¨ `EmailService` é¡åˆ¥ä¸­æ–°å¢æ–¹æ³•ï¼š

```javascript
static async sendCustomEmail({ to, patientName, customData }) {
  const subject = 'è‡ªè¨‚ä¸»æ—¨';
  const html = `
    <!DOCTYPE html>
    <html>
    <!-- æ‚¨çš„è‡ªè¨‚ HTML -->
    </html>
  `;

  return this.sendEmail({ to, subject, html });
}
```

---

## ğŸ“ˆ æœ€ä½³å¯¦è¸

### 1. éƒµä»¶ç™¼é€æ™‚æ©Ÿ

- âœ… **é ç´„ç¢ºèª**: å»ºç«‹é ç´„å¾Œç«‹å³ç™¼é€
- âœ… **é ç´„æé†’**: å‰ä¸€å¤©æ—©ä¸Š 9:00 ç™¼é€
- âœ… **é ç´„å–æ¶ˆ**: å–æ¶ˆå¾Œç«‹å³ç™¼é€
- âŒ **é¿å…**: åŠå¤œç™¼é€éƒµä»¶ï¼ˆæœƒè¢«è¦–ç‚ºåƒåœ¾éƒµä»¶ï¼‰

### 2. éƒµä»¶å…§å®¹åŸå‰‡

- ç°¡æ½”æ˜ç­ï¼Œé‡é»ä½¿ç”¨ç²—é«”
- åŒ…å«å¿…è¦è³‡è¨Šï¼ˆæ—¥æœŸã€æ™‚é–“ã€åœ°é»ï¼‰
- æä¾›è¯çµ¡æ–¹å¼
- ä½¿ç”¨å‹å–„ã€å°ˆæ¥­çš„èªæ°£

### 3. éš±ç§ä¿è­·

- ä¸åœ¨éƒµä»¶ä¸­åŒ…å«æ•æ„Ÿé†«ç™‚è³‡è¨Š
- ä½¿ç”¨åŠ å¯†é€£çµæä¾›è©³ç´°è³‡æ–™
- éµå®ˆå€‹è³‡æ³•è¦ç¯„

---

## ğŸ“ ç›¸é—œæ–‡ä»¶

- [Resend å®˜æ–¹æ–‡ä»¶](https://resend.com/docs)
- [Cloudflare DNS è¨­å®š](https://developers.cloudflare.com/dns/)
- [SPF/DKIM èªªæ˜](https://www.cloudflare.com/learning/dns/dns-records/dns-spf-record/)

---

## âœ… è¨­å®šå®Œæˆç¢ºèªæ¸…å–®

éƒ¨ç½²å‰è«‹ç¢ºèªï¼š

- [ ] Resend API Key å·²è¨­å®š
- [ ] è‡ªè¨‚ç¶²åŸŸå·²é©—è­‰ï¼ˆæ­£å¼ç’°å¢ƒï¼‰
- [ ] DNS è¨˜éŒ„å·²æ­£ç¢ºè¨­å®š
- [ ] ç’°å¢ƒè®Šæ•¸å·²æ›´æ–°
- [ ] æ¸¬è©¦éƒµä»¶ç™¼é€æˆåŠŸ
- [ ] éƒµä»¶æœªé€²å…¥åƒåœ¾éƒµä»¶
- [ ] éƒµä»¶æ¨£å¼åœ¨ä¸åŒéƒµä»¶å®¢æˆ¶ç«¯æ­£å¸¸é¡¯ç¤º

---

## ğŸ“š å®Œæ•´åŠŸèƒ½ç¸½è¦½

### å·²å¯¦ä½œåŠŸèƒ½æ¸…å–®

#### 1. éƒµä»¶ç™¼é€æœå‹™

- âœ… **ç”¨æˆ¶å¸³è™Ÿå¯†ç¢¼ç™¼é€** - æ–°å»ºè¨ºæ‰€ç”¨æˆ¶æ™‚è‡ªå‹•ç™¼é€æ­¡è¿éƒµä»¶
- âœ… **é ç´„æé†’éƒµä»¶** - è‡ªå‹•æé†’ç—…æ‚£é ç´„æ™‚é–“
- âœ… **é ç´„ç¢ºèªéƒµä»¶** - é ç´„æˆåŠŸå¾Œç«‹å³ç™¼é€ç¢ºèª
- âœ… **é ç´„å–æ¶ˆé€šçŸ¥** - é ç´„å–æ¶ˆæ™‚é€šçŸ¥ç—…æ‚£
- âœ… **ä¸€èˆ¬é€šçŸ¥éƒµä»¶** - è‡ªè¨‚æ¨™é¡Œå’Œå…§å®¹çš„é€šçŸ¥

#### 2. è‡ªå‹•æé†’ç³»çµ±

- âœ… **å®šæ™‚ä»»å‹™æœå‹™** - ä½¿ç”¨ node-cron æ’ç¨‹åŸ·è¡Œ
- âœ… **æ¯æ—¥è‡ªå‹•æé†’** - æ¯å¤©æ—©ä¸Š 9:00 ç™¼é€æ˜æ—¥é ç´„æé†’
- âœ… **å¤šçµ„ç¹”æ”¯æ´** - è‡ªå‹•è™•ç†æ‰€æœ‰å•Ÿç”¨ä¸­çš„è¨ºæ‰€
- âœ… **æ™ºèƒ½é¸æ“‡ç®¡é“** - æ ¹æ“šè¨­å®šè‡ªå‹•é¸æ“‡ Email æˆ– LINE
- âœ… **å®Œæ•´æ—¥èªŒè¨˜éŒ„** - è©³ç´°çš„åŸ·è¡Œæ—¥èªŒå’Œçµ±è¨ˆå ±å‘Š

#### 3. é€šçŸ¥è¨­å®šç®¡ç†

- âœ… **Email æé†’é–‹é—œ** - å‰ç«¯ UI å³æ™‚åˆ‡æ›
- âœ… **LINE æé†’é–‹é—œ** - å‰ç«¯ UI å³æ™‚åˆ‡æ›
- âœ… **è¨­å®š API** - GET/PUT endpoints for notification settings
- âœ… **å¤šç®¡é“ä¸¦è¡Œ** - å¯åŒæ™‚å•Ÿç”¨ Email å’Œ LINE

#### 4. æŠ€è¡“ç‰¹è‰²

- âœ… **éé˜»å¡ç™¼é€** - ä½¿ç”¨ `setImmediate()` é¿å…é˜»å¡ API å›æ‡‰
- âœ… **éŒ¯èª¤è™•ç†** - å®Œæ•´çš„ try-catch å’ŒéŒ¯èª¤æ—¥èªŒ
- âœ… **å¤šç§Ÿæˆ¶éš”é›¢** - æ¯å€‹çµ„ç¹”ç¨ç«‹çš„è¨­å®šå’Œè™•ç†
- âœ… **è³‡æ–™é©—è­‰** - å®Œæ•´çš„æ¬„ä½é©—è­‰å’ŒéŒ¯èª¤è¨Šæ¯
- âœ… **å®‰å…¨æ€§** - JWT èªè­‰ä¿è­·æ‰€æœ‰ API ç«¯é»

### æª”æ¡ˆæ¶æ§‹

```text
server/
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ emailService.js          # éƒµä»¶ç™¼é€æœå‹™ï¼ˆResend æ•´åˆï¼‰
â”‚   â””â”€â”€ cronJobs.js               # å®šæ™‚ä»»å‹™æœå‹™ï¼ˆè‡ªå‹•æé†’ï¼‰
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ email.js                  # éƒµä»¶ API è·¯ç”±
â”‚   â”œâ”€â”€ users.js                  # ç”¨æˆ¶ç®¡ç†ï¼ˆæ•´åˆå¸³è™Ÿéƒµä»¶ï¼‰
â”‚   â””â”€â”€ organizations.js          # çµ„ç¹”è¨­å®šï¼ˆé€šçŸ¥è¨­å®š APIï¼‰
â””â”€â”€ index.js                      # ä¼ºæœå™¨ä¸»æª”ï¼ˆå•Ÿå‹• cronï¼‰

src/
â””â”€â”€ components/
    â””â”€â”€ LineSettingsContent.tsx   # æ•´åˆè¨­å®šé é¢ï¼ˆé€šçŸ¥é–‹é—œ UIï¼‰

docs/
â””â”€â”€ EMAIL_SETUP_GUIDE.md          # æœ¬æ–‡ä»¶
```

### API ç«¯é»ç¸½è¦½

| ç«¯é» | æ–¹æ³• | åŠŸèƒ½ | èªè­‰ |
|------|------|------|------|
| `/api/email/status` | GET | æª¢æŸ¥éƒµä»¶æœå‹™ç‹€æ…‹ | âœ… |
| `/api/email/send/user-credentials` | POST | ç™¼é€ç”¨æˆ¶å¸³è™Ÿå¯†ç¢¼ | âœ… |
| `/api/email/send/appointment-reminder` | POST | ç™¼é€é ç´„æé†’ | âœ… |
| `/api/email/send/appointment-confirmation` | POST | ç™¼é€é ç´„ç¢ºèª | âœ… |
| `/api/email/send/appointment-cancellation` | POST | ç™¼é€é ç´„å–æ¶ˆé€šçŸ¥ | âœ… |
| `/api/email/send/notification` | POST | ç™¼é€ä¸€èˆ¬é€šçŸ¥ | âœ… |
| `/api/organizations/me/notifications` | GET | å–å¾—é€šçŸ¥è¨­å®š | âœ… |
| `/api/organizations/me/notifications` | PUT | æ›´æ–°é€šçŸ¥è¨­å®š | âœ… |

### ç’°å¢ƒè®Šæ•¸é…ç½®

```bash
# å¿…éœ€çš„ç’°å¢ƒè®Šæ•¸
RESEND_API_KEY=re_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
EMAIL_FROM=noreply@yourcompany.com

# å¯é¸çš„ç’°å¢ƒè®Šæ•¸ï¼ˆç”¨æ–¼è‡ªè¨‚ï¼‰
# NODE_ENV=production
# ALLOWED_ORIGINS=https://yourdomain.com
```

### è³‡æ–™åº«çµæ§‹

#### Organizations Table - Settings Field

```json
{
  "notifications": {
    "emailReminders": true,
    "lineReminders": false
  }
}
```

å„²å­˜åœ¨ `organizations.settings` TEXT/JSONB æ¬„ä½ä¸­ã€‚

### ä½¿ç”¨æµç¨‹ç¯„ä¾‹

#### 1. æ–°å¢è¨ºæ‰€ç”¨æˆ¶

```bash
POST /api/users
{
  "username": "clinic_admin",
  "password": "SecurePass123",
  "name": "ç‹é†«å¸«",
  "email": "doctor@example.com",
  "role": "admin"
}

# ç³»çµ±è‡ªå‹•ç™¼é€ï¼š
# âœ‰ï¸ æ­¡è¿éƒµä»¶å«å¸³è™Ÿå¯†ç¢¼ â†’ doctor@example.com
```

#### 2. è¨­å®šé€šçŸ¥åå¥½

```bash
# ç®¡ç†å“¡åœ¨å‰ç«¯åˆ‡æ›é–‹é—œ
PUT /api/organizations/me/notifications
{
  "emailReminders": true,
  "lineReminders": true
}

# ç³»çµ±å›æ‡‰ï¼š
{
  "success": true,
  "message": "é€šçŸ¥è¨­å®šå·²æ›´æ–°",
  "notifications": {
    "emailReminders": true,
    "lineReminders": true
  }
}
```

#### 3. è‡ªå‹•æé†’é‹ä½œ

```text
æ¯å¤© 09:00 è‡ªå‹•åŸ·è¡Œï¼š

1. æŸ¥è©¢æ˜æ—¥é ç´„
2. è®€å–çµ„ç¹”é€šçŸ¥è¨­å®š
3. æ ¹æ“šè¨­å®šç™¼é€æé†’ï¼š
   - Email å·²å•Ÿç”¨ + ç—…æ‚£æœ‰ email â†’ ç™¼é€ Email
   - LINE å·²å•Ÿç”¨ + ç—…æ‚£æœ‰ lineUserId â†’ ç™¼é€ LINE
4. è¨˜éŒ„çµ±è¨ˆä¸¦è¼¸å‡ºæ—¥èªŒ
```

### æ•…éšœæ’é™¤å¿«é€ŸæŒ‡å—

| å•é¡Œ | å¯èƒ½åŸå›  | è§£æ±ºæ–¹æ³• |
|------|----------|----------|
| éƒµä»¶æœªç™¼é€ | API Key æœªè¨­å®š | æª¢æŸ¥ `.env` ä¸­çš„ `RESEND_API_KEY` |
| å®šæ™‚ä»»å‹™æœªåŸ·è¡Œ | ä¼ºæœå™¨æœªå•Ÿå‹• cron | ç¢ºèª `server/index.js` æœ‰èª¿ç”¨ `startCronJobs()` |
| æé†’æœªè‡ªå‹•ç™¼é€ | é€šçŸ¥é–‹é—œæœªå•Ÿç”¨ | å‰å¾€æ•´åˆè¨­å®šé é¢å•Ÿç”¨é–‹é—œ |
| éƒµä»¶é€²åƒåœ¾éƒµä»¶ | ä½¿ç”¨æ¸¬è©¦ç¶²åŸŸ | è¨­å®šè‡ªè¨‚ç¶²åŸŸä¸¦é©—è­‰ DNS |
| æ˜æ–‡å¯†ç¢¼å®‰å…¨æ€§ | éƒµä»¶å…§å®¹å¯è¦‹ | æé†’ç”¨æˆ¶é¦–æ¬¡ç™»å…¥å¾Œç«‹å³ä¿®æ”¹å¯†ç¢¼ |

### å¾ŒçºŒå„ªåŒ–å»ºè­°

1. **LINE è¨Šæ¯æ•´åˆ** - ç›®å‰ cron ä¸­ LINE ç™¼é€ç‚º TODOï¼Œéœ€æ•´åˆ LINE Messaging API
2. **éƒµä»¶æ¨¡æ¿ç®¡ç†** - è€ƒæ…®ä½¿ç”¨è³‡æ–™åº«å„²å­˜éƒµä»¶æ¨¡æ¿ï¼Œæ–¹ä¾¿å®¢è£½åŒ–
3. **ç™¼é€æ­·å²è¨˜éŒ„** - æ–°å¢ `email_logs` è¡¨è¨˜éŒ„æ‰€æœ‰ç™¼é€æ­·å²
4. **é‡è©¦æ©Ÿåˆ¶** - å¤±æ•—æ™‚è‡ªå‹•é‡è©¦ï¼ˆexponential backoffï¼‰
5. **æ‰¹é‡ç™¼é€** - ä½¿ç”¨ Resend Batch API æå‡æ•ˆèƒ½
6. **ç›£æ§å‘Šè­¦** - æ•´åˆ Sentry æˆ–é¡ä¼¼æœå‹™ç›£æ§ç™¼é€å¤±æ•—ç‡

---

**æ–‡ä»¶ç‰ˆæœ¬**: v1.0
**æœ€å¾Œæ›´æ–°**: 2025-11-19
**ç¶­è­·è€…**: Patient CRM é–‹ç™¼åœ˜éšŠ

---

**è¨­å®šè€…**: _å¾…å¡«å¯«_
**é©—è­‰æ—¥æœŸ**: _å¾…å¡«å¯«_
**ä¸Šç·šæ—¥æœŸ**: _å¾…å¡«å¯«_
