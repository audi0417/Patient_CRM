# 病患 CRM 系統 - 資料隱私、法規合規與混合部署架構規劃

## 文檔概述

本規劃文檔針對病患 CRM 系統提出全面的資料邊界管理、病患隱私保護及混合部署架構方案，以滿足台灣醫療院所在資料主權、法規合規與靈活部署方面的需求。

**版本**: 1.0
**日期**: 2026-01-30
**狀態**: 規劃階段

---

## 目錄

1. [專案背景與目標](#專案背景與目標)
2. [現況分析](#現況分析)
3. [法規合規要求](#法規合規要求)
4. [混合部署架構設計](#混合部署架構設計)
5. [實施階段規劃](#實施階段規劃)
6. [風險評估與緩解策略](#風險評估與緩解策略)
7. [其他可實作模組建議](#其他可實作模組建議)

---

## 專案背景與目標

### 核心問題

台灣醫療院所在採用病患管理系統時面臨以下挑戰：

1. **資料主權顧慮**: 小型診所擔心病患資料上雲後的控制權問題
2. **法規合規壓力**: 必須符合個資法（PDPA）及醫療法規要求
3. **部署彈性需求**: 不同規模機構需要不同的部署方案
4. **資料隔離要求**: 多租戶環境下必須確保組織間資料完全隔離
5. **連鎖經營需求**: 醫療集團需要中央管理多個分院的能力

### 專案目標

- ✅ **強化資料邊界**: 確保組織間資料在應用層與資料庫層雙重隔離
- ✅ **達成法規合規**: 符合台灣個資法、醫療法，並為 HIPAA 對齊做準備
- ✅ **支援混合部署**: 提供本地、雲端、混合三種部署模式
- ✅ **保護病患隱私**: 敏感醫療資料欄位加密，完整稽核追蹤
- ✅ **維持向下相容**: 現有雲端部署不受影響

---

## 現況分析

### 系統架構現況

**前端架構**:
- React 18.3.1 + TypeScript
- React Router v6 路由
- Zustand 狀態管理
- Radix UI + Tailwind CSS
- 支援 Web (Vite) 和 Desktop (Electron) 模式

**後端架構**:
- Express.js 5.1
- SQLite (本地) / PostgreSQL (雲端) 雙資料庫支援
- JWT 認證機制（24 小時有效期）
- 多租戶隔離中介層 (tenantContext.js)

**多租戶實作**:
- 基於 `organizationId` 的行級隔離
- `TenantQuery` 幫助類別自動過濾組織資料
- 三種角色：super_admin、admin、user

### 關鍵安全問題（急需修復）

| 嚴重性 | 問題描述 | 影響 | 所在位置 |
|--------|---------|------|---------|
| 🔴 高危 | **密碼使用 SHA256 無鹽值雜湊** | 容易受彩虹表攻擊 | 5 個檔案共 17 處 |
| 🔴 高危 | **敏感醫療資料明文儲存** | 無法符合加密要求 | patients, consultations 資料表 |
| 🟠 中危 | **無稽核日誌系統** | 無法證明合規性 | 全系統 |
| 🟠 中危 | **Super Admin 跨組織 PII 洩漏** | 違反資料邊界原則 | `/api/superadmin/patients` |
| 🟡 低危 | **JWT 無刷新機制** | 用戶體驗不佳 | auth.js |

### 資料敏感度分類

**醫療資料表與敏感欄位**:

| 資料表 | 需加密欄位 | 個資欄位（需記錄存取） |
|--------|-----------|---------------------|
| `patients` | medicalHistory, allergies, bloodType, emergencyContact | name, phone, email, birthDate, address |
| `body_composition` | notes | 所有欄位（連結至 patientId） |
| `vital_signs` | notes | 所有欄位（連結至 patientId） |
| `consultations` | chiefComplaint, assessment, plan, notes | 所有欄位（連結至 patientId） |
| `goals` | description | currentValue, targetValue |
| `users` | password (已加密但演算法弱) | username, email, name |

---

## 法規合規要求

### 台灣個人資料保護法（PDPA）

| 法規要求 | 現況 | 差距 | 對應實施階段 |
|---------|------|------|-------------|
| **明確蒐集同意** | 未實作 | 缺少同意追蹤機制 | 階段 2.4 |
| **特定目的限制** | 部分（組織隔離） | 無使用目的追蹤 | 階段 2.5 |
| **當事人權利（查閱/匯出/刪除）** | 部分（管理員可查看） | 無病患自助入口 | 階段 4.1 |
| **跨境傳輸限制** | 未強制執行 | 無部署模式感知 | 階段 3.2 |
| **資料外洩通知** | 未實作 | 無異常偵測機制 | 階段 3.5 |
| **適當安全措施** | 弱（SHA256、無日誌） | 多項缺口 | 階段 1 全部 |
| **保存期限規範** | 未實作 | 無保留政策引擎 | 階段 2.6 |

### 醫療法相關規定

**第 68 條**: 醫療紀錄至少保存 7 年（未成年者 10 年）
**第 72 條**: 病歷內容保密，未經同意不得洩漏
**第 70 條**: 病歷應保持原貌，電子病歷需具同等效力

### HIPAA 對齊（國際準備）

| HIPAA 要求 | 對應元件 | 實施階段 |
|-----------|---------|---------|
| 存取控制 (§164.312(a)) | RBAC + 稽核日誌 | 階段 1 |
| 稽核控制 (§164.312(b)) | 稽核日誌系統 | 階段 1 |
| 完整性控制 (§164.312(c)) | 欄位加密、雜湊驗證 | 階段 2 |
| 傳輸安全 (§164.312(e)) | TLS 強制、加密同步 | 階段 3 |
| 靜態加密 (§164.312(a)(2)(iv)) | 欄位級 AES-256-GCM | 階段 2 |

---

## 混合部署架構設計

### 三層部署模式

我們設計了三種部署層級，滿足不同規模醫療機構的需求：

#### 🏥 Tier 1：小型診所（本地部署）

**特性**:
- Electron 桌面應用 + SQLite 資料庫
- 資料 100% 保存在診所本地
- 無需網路連線即可運作
- 適合：個人診所、小型醫療所

**資料主權**:
- ✅ 資料永不離開診所
- ✅ 完全離線操作能力
- ✅ 物理隔離保證安全性

**限制**:
- ❌ 無 LINE 訊息功能
- ❌ 無電子郵件通知
- ❌ 無雲端管理後台

#### 🏥 Tier 2：中型診所（本地+雲端備份）

**特性**:
- 日常運作使用本地 SQLite
- 定期加密備份至雲端儲存
- 加密金鑰由診所持有（雲端無法解密）
- 適合：中型診所、連鎖診所分店

**資料主權**:
- ✅ 主資料保存在本地
- ✅ 雲端僅存放加密備份（無解密金鑰）
- ✅ 診所完全控制資料存取

**功能**:
- ✅ LINE 訊息整合（需網路）
- ✅ 電子郵件通知
- ✅ 中央管理（僅統計資料，無 PII）

#### 🏥 Tier 3：醫療集團（雲端部署）

**特性**:
- PostgreSQL 雲端資料庫
- 多組織中央管理
- 跨分院資料隔離
- 適合：醫療集團、連鎖醫院

**資料主權**:
- 資料存放於雲端 PostgreSQL
- 透過 Row-Level Security (RLS) 強制隔離
- Super Admin 可管理但不可存取臨床資料

**功能**:
- ✅ 所有功能完整支援
- ✅ 集團層級分析報表
- ✅ 跨分院使用者管理

### 架構圖

```
┌─────────────────────────────────────────────┐
│      中央管理雲端（PostgreSQL）              │
│                                             │
│  • Super Admin 管理後台（無 Tier1/2 病患PII）│
│  • 組織授權管理                              │
│  • 加密備份儲存（無解密金鑰）                 │
│  • 匯總分析報表（僅統計，無 PII）             │
└──────────────┬──────────────────────────────┘
               │ TLS + mTLS 同步 API
               │
    ┌──────────┼──────────┐
    │          │          │
┌───▼────┐ ┌──▼──────┐ ┌─▼────────┐
│ Tier 1 │ │ Tier 2  │ │ Tier 3   │
│小型診所│ │中型診所  │ │醫療集團   │
│        │ │         │ │          │
│Electron│ │Electron │ │ Browser  │
│ SQLite │ │ SQLite  │ │  + PG    │
│本地資料│ │本地+備份│ │雲端資料   │
│完全離線│ │加密備份  │ │多組織     │
└────────┘ └─────────┘ └──────────┘
```

### 部署模式配置

透過環境變數 `DEPLOYMENT_MODE` 控制：

```bash
# Tier 1：本地部署
DEPLOYMENT_MODE=local

# Tier 2：本地 + 雲端備份
DEPLOYMENT_MODE=local_sync

# Tier 3：雲端部署（預設，向下相容）
DEPLOYMENT_MODE=cloud
```

### 模組部署矩陣

| 模組 | Tier 1 (本地) | Tier 2 (本地+備份) | Tier 3 (雲端) |
|------|--------------|-------------------|--------------|
| 病患管理 | 本地 SQLite | 本地 SQLite + 雲端加密備份 | 雲端 PostgreSQL |
| 健康紀錄 | 本地 SQLite | 本地 SQLite + 雲端加密備份 | 雲端 PostgreSQL |
| 預約排程 | 本地 SQLite | 本地 SQLite + 雲端加密備份 | 雲端 PostgreSQL |
| 診療記錄 | 本地 SQLite | 本地 SQLite + 雲端加密備份 | 雲端 PostgreSQL |
| 療程套餐 | 本地 SQLite | 本地 SQLite + 雲端加密備份 | 雲端 PostgreSQL |
| LINE 訊息 | ❌ 停用 | ✅ 雲端（需網路） | ✅ 雲端 PostgreSQL |
| 電子郵件通知 | ❌ 停用 | ✅ 雲端轉發 | ✅ 雲端 |
| 稽核日誌 | 本地 SQLite | 本地 + 雲端鏡像 | 雲端 PostgreSQL |
| 使用者認證 | 本地 SQLite | 本地（同步使用者清單） | 雲端 PostgreSQL |
| 超級管理後台 | ❌ 停用 | ✅ 雲端（僅管理資料） | ✅ 雲端 PostgreSQL |
| 分析報表 | 僅本地 | 本地 + 匯總至雲端 | 雲端 PostgreSQL |

### 資料主權規則

1. **Tier 1 組織**: 病患資料永不離開本地機器。中央管理雲端僅知道組織名稱、授權狀態、匯總統計（病患數、使用者數）。無 PII 跨越網路邊界。

2. **Tier 2 組織**: 病患資料在本地加密後才傳輸至雲端備份儲存。雲端沒有解密金鑰（金鑰保留在診所）。這是「加密 Blob」備份模式。

3. **Tier 3 組織**: 資料存放於雲端 PostgreSQL。跨組織存取由 TenantQuery 系統阻止。Super Admin 可查看管理指標但不得存取個別病患紀錄（需強制執行）。

---

## 實施階段規劃

詳細實施步驟請參閱：[實施階段詳細說明文檔](./實施階段詳細說明.md)

### 階段概覽

| 階段 | 名稱 | 工期 | 優先級 | 狀態 |
|------|------|------|--------|------|
| 階段 1 | 安全性強化 | 2 週 | 🔴 緊急 | 未開始 |
| 階段 2 | 資料隱私與加密 | 3 週 | 🔴 高 | 未開始 |
| 階段 3 | 混合部署架構 | 4 週 | 🟠 中 | 未開始 |
| 階段 4 | 進階合規功能 | 3-4 週 | 🟡 低 | 未開始 |

### 階段 1：安全性強化（緊急）

**目標**: 修復所有關鍵安全漏洞
**工期**: 2 週
**前置條件**: 無

**關鍵任務**:
- ✅ 密碼雜湊從 SHA256 遷移至 bcrypt
- ✅ 實作稽核日誌系統
- ✅ 移除 Super Admin 跨組織 PII 端點
- ✅ 強化 TenantQuery 原生查詢檢查
- ✅ JWT 安全性改進（刷新機制、撤銷）

### 階段 2：資料隱私與加密

**目標**: 敏感資料加密、同意追蹤、保留政策
**工期**: 3 週
**前置條件**: 階段 1 完成

**關鍵任務**:
- ✅ 敏感健康資料欄位加密（AES-256-GCM）
- ✅ PostgreSQL Row-Level Security (RLS)
- ✅ 資料分類與存取控制矩陣
- ✅ 病患同意追蹤系統
- ✅ 使用目的限制追蹤
- ✅ 資料保留政策引擎

### 階段 3：混合部署架構

**目標**: 支援本地、雲端、混合部署
**工期**: 4 週
**前置條件**: 階段 1 完成（階段 2 可平行進行）

**關鍵任務**:
- ✅ 部署模式感知配置
- ✅ Electron 生產版本（內嵌伺服器）
- ✅ 加密雲端備份（Tier 2）
- ✅ 中央管理 API（mTLS）
- ✅ 資料外洩偵測與警報

### 階段 4：進階合規功能（未來）

**目標**: 完整法規合規與自助功能
**工期**: 3-4 週
**前置條件**: 階段 2、3 完成

**關鍵任務**:
- ✅ 病患資料存取請求入口
- ✅ 跨境傳輸控制
- ✅ 資料處理協議（DPA）管理

---

## 風險評估與緩解策略

### 關鍵風險

| 風險 | 嚴重性 | 影響 | 緩解策略 |
|------|--------|------|---------|
| 欄位加密遷移損壞既有資料 | 🔴 高 | 資料遺失 | 遷移前完整備份；包含驗證步驟（解密並比對原始值）；記錄回滾程序並測試；先在測試環境執行 |
| bcrypt 遷移導致使用者鎖定 | 🟠 中 | 服務中斷 | 雙重雜湊驗證（支援 bcrypt 和舊版 SHA256）；成功登入後透明地重新雜湊；無需強制重設密碼 |
| Electron + 內嵌伺服器打包失敗 | 🟠 中 | Tier 1/2 無法部署 | 使用 `electron-rebuild`（已在 devDependencies）；在 Windows、macOS、Linux 測試建置管道；如原生建置有問題則降級至 `sql.js`（WASM 版 SQLite） |
| 稽核日誌造成大量資料庫寫入負載 | 🟡 低 | 效能下降 | 非同步寫入佇列；批次插入；獨立稽核日誌資料表配置 WAL；考慮日誌輪替（1 年以上歸檔） |
| 單組織加密金鑰衍生增加金鑰管理複雜度 | 🟡 低 | 營運複雜度 | 使用標準 HKDF 從主 ENCRYPTION_KEY 衍生；記錄金鑰復原程序；Tier 2 的診所持有密碼為復原機制 |

### 向下相容性保證

- 預設 `DEPLOYMENT_MODE=cloud` 保留所有現有行為
- 新功能為累加式（additive）
- Schema 遷移使用 `CREATE TABLE IF NOT EXISTS` 和帶欄位存在性檢查的 `ALTER TABLE`
- 現有 Zeabur 部署無需任何變更即可繼續運作

---

## 其他可實作模組建議

除了核心的隱私合規與混合部署架構外，以下模組可進一步提升系統價值：

### 🔐 進階安全模組

#### 1. 雙因素驗證（2FA）

**價值**: 顯著提升帳號安全性，符合高安全性醫療機構需求

**實作方式**:
- 支援 TOTP（Google Authenticator、Authy）
- 備用恢復碼（一次性使用）
- SMS 驗證碼（選配）
- 強制特定角色啟用 2FA（如 Super Admin）

**技術架構**:
```javascript
// 新增資料表
CREATE TABLE user_2fa (
  userId TEXT PRIMARY KEY,
  secret TEXT NOT NULL,        -- TOTP 密鑰（加密儲存）
  backupCodes TEXT,            -- JSON 陣列的備用碼
  isEnabled BOOLEAN DEFAULT false,
  enabledAt TIMESTAMP
);
```

**相關檔案**:
- `server/routes/auth.js` - 新增 2FA 端點
- `server/middleware/2fa.js` - 2FA 驗證中介層
- `src/pages/SecuritySettings.tsx` - 前端設定頁

#### 2. IP 白名單管理

**價值**: 限制特定 IP 範圍存取，防止異地登入攻擊

**實作方式**:
- 組織層級 IP 白名單配置
- 自動信任內網 IP（192.168.x.x、10.x.x.x）
- IP 範圍支援（CIDR 表示法）
- 異常 IP 登入警報

**技術架構**:
```javascript
CREATE TABLE ip_whitelists (
  id INTEGER PRIMARY KEY,
  organizationId TEXT,
  ipRange TEXT,              -- CIDR 格式：192.168.1.0/24
  description TEXT,
  isActive BOOLEAN DEFAULT true
);
```

#### 3. 會話管理與裝置追蹤

**價值**: 使用者可查看所有登入裝置並遠端登出

**功能**:
- 顯示所有活躍會話（裝置類型、位置、最後活動時間）
- 遠端登出特定裝置
- 可疑登入通知
- 強制所有裝置重新登入（密碼變更後）

---

### 📊 進階分析模組

#### 4. 病患健康趨勢分析

**價值**: 視覺化病患健康數據變化，輔助醫療決策

**功能**:
- 體重、BMI、血壓、血糖趨勢圖
- 多項指標對比（如體重 vs 體脂率）
- 異常值自動標記
- 健康評分演算法

**技術實作**:
- 使用 Chart.js 或 Recharts 繪圖
- 時間範圍選擇器（7 天、30 天、90 天、全部）
- 匯出為 PDF 報告

#### 5. 組織營運儀表板

**價值**: 管理者快速掌握診所營運狀況

**功能**:
- 每日/每週/每月新增病患數
- 預約填充率（Appointment Fill Rate）
- 療程完成率
- 使用者活躍度
- 熱門服務類型統計

**權限控制**:
- Admin 可查看本組織儀表板
- Super Admin 可查看跨組織匯總（無個別病患資料）

---

### 🤖 自動化與整合模組

#### 6. 預約提醒自動化

**價值**: 減少爽約率，提升病患滿意度

**功能**:
- 預約前 24 小時 LINE 提醒
- 預約前 1 小時 SMS 提醒（選配）
- 電子郵件提醒
- 自動重發未讀提醒

**技術架構**:
- 擴展現有 `cronJobs.js` 新增提醒任務
- 使用現有 LINE Messaging API 整合
- 新增 SMS 整合（如三竹資訊、每日簡訊）

#### 7. 電子病歷範本系統

**價值**: 加速診療記錄輸入，標準化醫療文書

**功能**:
- 預設範本（如感冒診斷、慢性病追蹤）
- 自訂範本（診所可建立專屬範本）
- 範本變數（如 {{patientName}}、{{todayDate}}）
- 快速插入常用詞彙（藥品名、診斷術語）

**技術實作**:
```javascript
CREATE TABLE consultation_templates (
  id INTEGER PRIMARY KEY,
  organizationId TEXT,
  name TEXT,
  category TEXT,              -- 內科、外科、兒科等
  chiefComplaintTemplate TEXT,
  assessmentTemplate TEXT,
  planTemplate TEXT,
  tags TEXT                   -- JSON 陣列
);
```

#### 8. 藥品庫存管理

**價值**: 追蹤診所藥品庫存，避免缺貨或過期

**功能**:
- 藥品基本資料（名稱、成分、劑量、單位）
- 庫存數量追蹤
- 低庫存警報
- 效期管理（即將過期提醒）
- 進貨/出貨紀錄

**資料結構**:
```javascript
CREATE TABLE medications (
  id INTEGER PRIMARY KEY,
  organizationId TEXT,
  name TEXT,
  ingredient TEXT,            -- 成分
  dosage TEXT,                -- 劑量
  unit TEXT,                  -- mg, ml, 顆等
  stock INTEGER DEFAULT 0,
  minStock INTEGER,           -- 低庫存閾值
  expiryDate DATE
);

CREATE TABLE medication_logs (
  id INTEGER PRIMARY KEY,
  medicationId TEXT,
  type TEXT,                  -- 'in'（進貨）或 'out'（出貨）
  quantity INTEGER,
  relatedConsultationId TEXT, -- 若為出貨，關聯至診療記錄
  notes TEXT,
  timestamp TIMESTAMP
);
```

---

### 💳 營收管理模組

#### 9. 收費與帳單系統

**價值**: 整合診療與收費，簡化財務管理

**功能**:
- 服務項目收費標準設定
- 診療後自動產生帳單
- 多種付款方式記錄（現金、信用卡、保險）
- 應收帳款追蹤
- 收據列印/電子郵件寄送

**資料結構**:
```javascript
CREATE TABLE invoices (
  id INTEGER PRIMARY KEY,
  organizationId TEXT,
  patientId TEXT,
  consultationId TEXT,
  amount DECIMAL(10,2),
  paidAmount DECIMAL(10,2),
  paymentMethod TEXT,         -- cash, credit_card, insurance
  status TEXT,                -- unpaid, partial, paid
  issuedAt TIMESTAMP,
  paidAt TIMESTAMP
);

CREATE TABLE invoice_items (
  id INTEGER PRIMARY KEY,
  invoiceId TEXT,
  serviceTypeId TEXT,
  description TEXT,
  quantity INTEGER,
  unitPrice DECIMAL(10,2),
  subtotal DECIMAL(10,2)
);
```

#### 10. 療程套餐進度追蹤

**價值**: 管理病患購買的療程套餐，追蹤使用進度

**功能**:
- 套餐購買記錄（如「10 次物理治療」）
- 每次使用自動扣次數
- 剩餘次數顯示
- 到期日提醒
- 療程效果記錄

**擴展現有 `treatment_packages` 資料表**:
```javascript
CREATE TABLE package_purchases (
  id INTEGER PRIMARY KEY,
  organizationId TEXT,
  patientId TEXT,
  packageId TEXT,
  totalSessions INTEGER,      -- 總次數
  usedSessions INTEGER DEFAULT 0,
  remainingSessions INTEGER,
  purchaseDate DATE,
  expiryDate DATE,
  status TEXT                 -- active, completed, expired
);

CREATE TABLE package_usage_logs (
  id INTEGER PRIMARY KEY,
  purchaseId TEXT,
  consultationId TEXT,
  usedAt TIMESTAMP,
  notes TEXT
);
```

---

### 🏥 進階醫療功能

#### 11. 影像管理系統（PACS 精簡版）

**價值**: 儲存和檢視醫療影像（X 光、超音波等）

**功能**:
- 影像上傳（JPEG、PNG、DICOM）
- 影像檢視器（縮放、亮度調整）
- 影像與診療記錄關聯
- 影像標註功能
- DICOM metadata 解析（若需要）

**儲存策略**:
- Tier 1/2: 本地檔案系統 + 路徑記錄於資料庫
- Tier 3: 雲端物件儲存（S3）+ CDN

**安全考量**:
- 影像檔案加密（靜態加密）
- 存取權限與稽核（與病患記錄相同層級）

#### 12. 檢驗報告整合

**價值**: 整合外部檢驗所報告，集中管理病患健康資料

**功能**:
- 檢驗報告 PDF 上傳
- 檢驗項目資料化（血液檢驗、尿液檢驗等）
- 異常值自動標記
- 歷史報告對比
- 與診療記錄關聯

**資料結構**:
```javascript
CREATE TABLE lab_reports (
  id INTEGER PRIMARY KEY,
  organizationId TEXT,
  patientId TEXT,
  reportDate DATE,
  labName TEXT,               -- 檢驗所名稱
  reportType TEXT,            -- blood, urine, xray, etc.
  filePath TEXT,              -- PDF 檔案路徑
  items TEXT                  -- JSON 陣列的檢驗項目
);

// items JSON 範例
{
  "items": [
    {"name": "白血球", "value": 7200, "unit": "/μL", "normalRange": "4000-10000", "isNormal": true},
    {"name": "血紅素", "value": 11.5, "unit": "g/dL", "normalRange": "12-16", "isNormal": false}
  ]
}
```

#### 13. 家族病史管理

**價值**: 記錄病患家族遺傳性疾病，輔助診斷

**功能**:
- 家族成員關係圖（父母、兄弟姊妹）
- 家族成員疾病記錄
- 遺傳風險評估
- 家族病史視覺化（家族樹）

---

### 📱 病患互動模組

#### 14. 病患自助入口（Patient Portal）

**價值**: 提升病患參與度，減少診所行政負擔

**功能**:
- 病患線上預約（查看空檔、預約、取消）
- 查看個人健康紀錄（病歷、檢驗報告）
- 下載收據與證明文件
- 線上問診（非即時，訊息回覆）
- 健康教育文章推播

**權限控制**:
- 病患僅可查看自己的資料
- 敏感資料需醫師授權才顯示
- 完整稽核記錄

**技術實作**:
- 獨立前端應用（或現有應用的子路由）
- 病患專用 JWT token（role: patient）
- 手機號碼 + OTP 驗證登入

#### 15. 健康教育內容管理

**價值**: 推廣預防醫學，提升病患健康意識

**功能**:
- 文章分類管理（慢性病管理、營養、運動等）
- 文章編輯器（富文本、圖片）
- 標籤系統
- 推薦演算法（基於病患健康狀況推薦相關文章）
- 閱讀追蹤

---

### 🔧 系統維運模組

#### 16. 自動備份與災難復原

**價值**: 確保資料安全，快速從災難復原

**功能**:
- 自動定時備份（每日/每週）
- 多版本備份保留
- 備份完整性驗證
- 一鍵還原功能
- 異地備份（Tier 2/3）

**實作策略**:
- SQLite: 定時檔案複製 + WAL checkpoint
- PostgreSQL: pg_dump + WAL archiving
- 加密備份檔案（AES-256）
- 備份至外部儲存（S3、本地 NAS）

#### 17. 系統健康監控

**價值**: 主動偵測系統問題，提升可靠性

**功能**:
- 資料庫效能監控（查詢時間、連線數）
- API 回應時間追蹤
- 錯誤率監控
- 磁碟空間警報
- 自動健康檢查端點（/health）

**技術選項**:
- 簡單版：自行實作 + 日誌
- 進階版：整合 Prometheus + Grafana

#### 18. 稽核日誌檢視器

**價值**: 方便管理員查詢稽核日誌，用於合規檢查

**功能**:
- 多維度篩選（時間、使用者、資源、操作）
- 全文檢索
- 匯出為 CSV/Excel（用於稽核報告）
- 視覺化圖表（操作類型分布、最活躍使用者）

**前端實作**:
- 表格元件（支援排序、分頁）
- 進階搜尋介面
- 時間範圍選擇器

---

### 📦 模組實作優先級建議

| 優先級 | 模組 | 理由 |
|-------|------|------|
| 🔴 高 | 雙因素驗證 | 顯著提升安全性，符合合規要求 |
| 🔴 高 | 預約提醒自動化 | 直接提升營運效率，減少爽約 |
| 🔴 高 | 自動備份與災難復原 | 資料安全基礎設施 |
| 🟠 中 | 病患健康趨勢分析 | 提升醫療決策品質 |
| 🟠 中 | 收費與帳單系統 | 完整閉環管理 |
| 🟠 中 | 電子病歷範本系統 | 加速診療流程 |
| 🟠 中 | 系統健康監控 | 提升系統可靠性 |
| 🟡 低 | 病患自助入口 | 提升病患體驗（需額外開發資源） |
| 🟡 低 | 影像管理系統 | 適合影像診斷較多的科別 |
| 🟡 低 | 藥品庫存管理 | 適合有診所藥局的機構 |

---

## 附錄

### 附錄 A：檔案影響清單

詳見 [實施階段詳細說明文檔](./實施階段詳細說明.md)

### 附錄 B：建議實作順序

```
第 1-2 週:   階段 1（步驟 1.1 → 1.2 → 1.3 → 1.4 → 1.5）
第 3-5 週:   階段 2（步驟 2.1 → 2.2 → 2.3 → 2.4 → 2.5 → 2.6）
第 6-9 週:   階段 3（步驟 3.1 → 3.2 → 3.3 → 3.4 → 3.5）
第 10-13 週: 階段 4（步驟 4.1 → 4.2 → 4.3）
```

階段 1 是所有後續階段的前置條件。在階段 1 內，步驟依相依性和影響程度排序。階段 2 和階段 3 在階段 1 完成後可平行進行，但階段 2 應優先處理，因為隱私合規是法律要求，而混合部署是業務要求。

### 附錄 C：技術堆疊總覽

**前端**:
- React 18.3.1 + TypeScript
- Vite / Electron
- Zustand (狀態管理)
- Radix UI + Tailwind CSS

**後端**:
- Node.js + Express.js 5.1
- better-sqlite3 / pg (資料庫驅動)
- bcryptjs (密碼雜湊)
- jsonwebtoken (JWT)

**資料庫**:
- SQLite 3.x (本地)
- PostgreSQL 14+ (雲端)

**安全**:
- AES-256-GCM (欄位加密)
- bcrypt cost factor 12 (密碼)
- HKDF (金鑰衍生)
- TLS 1.3 / mTLS (傳輸)

---

## 結論

本規劃提供了一個全面的路徑圖，使病患 CRM 系統能夠：

1. ✅ 符合台灣個資法與醫療法規要求
2. ✅ 支援小型診所到醫療集團的不同部署需求
3. ✅ 保護病患隱私與資料主權
4. ✅ 維持系統安全性與可靠性
5. ✅ 保持向下相容，不影響現有部署

透過分階段實施，我們可以先修復關鍵安全問題，再逐步建構進階功能。混合部署架構讓醫療機構可以根據自身需求選擇最適合的模式，而中央管理雲端則提供統一的授權管理與備份服務。

**下一步建議**: 先從階段 1 的密碼雜湊遷移（步驟 1.1）開始，因為這是最關鍵的安全問題且沒有相依性。

---

**文檔版本**: 1.0
**最後更新**: 2026-01-30
**維護者**: 系統架構團隊
