# LINE åœ–ç‰‡è¨Šæ¯åŠŸèƒ½å¯¦ä½œç¸½çµ

> **å®Œæˆæ—¥æœŸ**: 2025-11-19
> **ç‹€æ…‹**: âœ… å·²å®Œæˆæ‰€æœ‰ 5 å€‹éšæ®µ

---

## ğŸ“‹ å¯¦ä½œæ¦‚è¦½

æˆåŠŸå¯¦ä½œ LINE åœ–ç‰‡è¨Šæ¯çš„å®Œæ•´åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š
- âœ… å¾Œç«¯ Webhook åœ–ç‰‡æ¥æ”¶
- âœ… åœ–ç‰‡ä¸‹è¼‰å’Œç¸®åœ–ç”Ÿæˆï¼ˆä½¿ç”¨ Sharpï¼‰
- âœ… åœ–ç‰‡å„²å­˜å’Œå®‰å…¨å­˜å– API
- âœ… å‰ç«¯åœ–ç‰‡æ¸²æŸ“å’Œæ‡¶åŠ è¼‰
- âœ… åœ–ç‰‡æ”¾å¤§æª¢è¦–å™¨ï¼ˆLightboxï¼‰

---

## ğŸ¯ æ ¸å¿ƒæ¶æ§‹

```
LINE Bot å‚³é€åœ–ç‰‡
      â†“
Webhook æ¥æ”¶äº‹ä»¶ (lineWebhook.js)
      â†“
éåŒæ­¥è™•ç† (LineMessagingService.processImageMessage)
      â†“
ä¸‹è¼‰åŸåœ– â†’ ç”Ÿæˆç¸®åœ– (Sharp 400px å¯¬)
      â†“
å„²å­˜æª”æ¡ˆ (/data/line_images/{orgId}/)
      â†“
æ›´æ–°è¨Šæ¯ metadata
      â†“
å‰ç«¯æ¸²æŸ“ç¸®åœ– (LineMessages.tsx)
      â†“
é»æ“Šæ”¾å¤§é¡¯ç¤ºåŸåœ– (Lightbox)
```

---

## ğŸ“ ä¿®æ”¹çš„æª”æ¡ˆ

### å¾Œç«¯ (Server)

#### 1. **server/routes/lineWebhook.js**
- **æ–°å¢**: `handleImageMessage` å‡½æ•¸
- **ä¿®æ”¹**: `handleMessageEvent` æ–°å¢ `case 'image'`
- **åŠŸèƒ½**: æ¥æ”¶ LINE åœ–ç‰‡äº‹ä»¶ï¼Œå„²å­˜åˆå§‹è¨Šæ¯è¨˜éŒ„ï¼ŒéåŒæ­¥è™•ç†åœ–ç‰‡

#### 2. **server/services/lineMessaging.js**
- **æ–°å¢ä¾è³´**: `sharp`, `fs.promises`, `path`
- **æ–°å¢å¸¸æ•¸**: `LINE_API_CONTENT`, `IMAGE_STORAGE_BASE`
- **æ–°å¢æ–¹æ³•**:
  - `processImageMessage()` - ä¸»è¦åœ–ç‰‡è™•ç†æµç¨‹
  - `downloadImageFromLine()` - å¾ LINE API ä¸‹è¼‰åœ–ç‰‡
  - `saveImageFiles()` - å„²å­˜åŸåœ–å’Œç”Ÿæˆç¸®åœ–
- **åŠŸèƒ½**: å®Œæ•´çš„åœ–ç‰‡ä¸‹è¼‰ã€å£“ç¸®ã€å„²å­˜æµç¨‹

#### 3. **server/routes/line.js**
- **æ–°å¢è·¯ç”±**: `GET /api/line/images/:organizationId/:filename`
- **åŠŸèƒ½**: æä¾›åœ–ç‰‡å­˜å– APIï¼ŒåŒ…å«æ¬Šé™é©—è­‰å’Œå®‰å…¨æª¢æŸ¥

### å‰ç«¯ (Client)

#### 4. **src/pages/LineMessages.tsx**
- **æ–°å¢ç‹€æ…‹**: `selectedImage` (string | null)
- **æ–°å¢ useEffect**: ESC éµç›£è½é—œé–‰ Lightbox
- **æ–°å¢æ¸²æŸ“é‚è¼¯**: IMAGE é¡å‹è¨Šæ¯æ¸²æŸ“ï¼ˆç¬¬ 663-727 è¡Œï¼‰
- **æ–°å¢ UI**: åœ–ç‰‡æ”¾å¤§æª¢è¦–å™¨ Lightboxï¼ˆç¬¬ 819-851 è¡Œï¼‰
- **åŠŸèƒ½**: é¡¯ç¤ºç¸®åœ–ã€æ‡¶åŠ è¼‰ã€é»æ“Šæ”¾å¤§ã€æª”æ¡ˆå¤§å°æ¨™ç±¤

---

## ğŸ”§ æŠ€è¡“ç´°ç¯€

### åœ–ç‰‡è™•ç†è¦æ ¼

| é …ç›® | åŸåœ– | ç¸®åœ– |
|------|------|------|
| **æ ¼å¼** | JPEG | JPEG |
| **å“è³ª** | 90% | 80% |
| **å°ºå¯¸** | åŸå§‹å°ºå¯¸ | æœ€å¤§ 400px å¯¬ |
| **å„²å­˜è·¯å¾‘** | `/data/line_images/{orgId}/originals/` | `/data/line_images/{orgId}/thumbnails/` |
| **æª”åæ ¼å¼** | `msg_{messageId}_{timestamp}.jpg` | `msg_{messageId}_{timestamp}_thumb.jpg` |

### è¨Šæ¯ metadata çµæ§‹

```json
{
  "imageUrl": "/api/line/images/{orgId}/{filename}.jpg",
  "thumbnailUrl": "/api/line/images/{orgId}/{filename}_thumb.jpg",
  "originalSize": 2048576,
  "thumbnailSize": 153600,
  "width": 1920,
  "height": 1080,
  "format": "jpeg",
  "lineMessageId": "LINE è¨Šæ¯ ID",
  "processing": false
}
```

### å®‰å…¨æ©Ÿåˆ¶

1. **è·¯å¾‘éæ­·é˜²è­·**: æª¢æŸ¥æª”åæ˜¯å¦åŒ…å« `..`, `/`, `\`
2. **æª”æ¡ˆé¡å‹ç™½åå–®**: åƒ…å…è¨± `.jpg`, `.jpeg`, `.png`, `.webp`
3. **çµ„ç¹”éš”é›¢**: ä½¿ç”¨è€…åªèƒ½å­˜å–è‡ªå·±çµ„ç¹”çš„åœ–ç‰‡
4. **æ¬Šé™é©—è­‰**: éœ€è¦é€šé `authenticateToken` é©—è­‰

### æ•ˆèƒ½å„ªåŒ–

1. **éåŒæ­¥è™•ç†**: ä½¿ç”¨ `setImmediate` é¿å…é˜»å¡ Webhook å›æ‡‰
2. **æ‡¶åŠ è¼‰**: ä½¿ç”¨åŸç”Ÿ `loading="lazy"` å±¬æ€§
3. **å¿«å–ç­–ç•¥**: åœ–ç‰‡è¨­å®š `Cache-Control: max-age=31536000` (1 å¹´)
4. **ç¸®åœ–ç­–ç•¥**: æ¸›å°‘ 70-90% æµé‡å’Œè¼‰å…¥æ™‚é–“

---

## ğŸ¨ ä½¿ç”¨è€…é«”é©—

### åœ–ç‰‡è¨Šæ¯é¡¯ç¤º

- ğŸ“¸ **ç¸®åœ–é¡¯ç¤º**: æœ€å¤§å¯¬åº¦ 300pxï¼Œåœ“è§’ï¼Œé™°å½±
- ğŸ“ **æª”æ¡ˆå¤§å°æ¨™ç±¤**: å³ä¸‹è§’é¡¯ç¤ºåŸåœ–å¤§å°
- ğŸ“ **å°ºå¯¸æ¨™ç±¤**: æ»‘é¼ æ‡¸åœé¡¯ç¤ºåœ–ç‰‡å°ºå¯¸ï¼ˆå¯¬ Ã— é«˜ï¼‰
- â³ **è™•ç†ä¸­ç‹€æ…‹**: é¡¯ç¤ºè¼‰å…¥å‹•ç•«
- âŒ **éŒ¯èª¤è™•ç†**: é¡¯ç¤ºã€Œåœ–ç‰‡è¼‰å…¥å¤±æ•—ã€è¨Šæ¯

### Lightbox åŠŸèƒ½

- ğŸ–±ï¸ **é»æ“Šç¸®åœ–**: é–‹å•Ÿå…¨è¢å¹• Lightbox
- ğŸ–¼ï¸ **åŸåœ–é¡¯ç¤º**: æœ€å¤§åŒ–é¡¯ç¤ºé«˜è§£æåº¦åŸåœ–
- âŒ¨ï¸ **ESC é—œé–‰**: æŒ‰ ESC éµé—œé–‰
- ğŸ–±ï¸ **èƒŒæ™¯é»æ“Š**: é»æ“ŠèƒŒæ™¯é—œé–‰
- âŒ **é—œé–‰æŒ‰éˆ•**: å³ä¸Šè§’é¡¯ç¤ºé—œé–‰æŒ‰éˆ•
- ğŸ’¬ **æç¤ºæ–‡å­—**: åº•éƒ¨é¡¯ç¤ºæ“ä½œæç¤º

---

## ğŸ“¦ ä¾è³´å¥—ä»¶

### æ–°å¢å®‰è£

```bash
npm install sharp
```

### ç¾æœ‰å¥—ä»¶ä½¿ç”¨

- `lucide-react` - åœ–ç¤ºï¼ˆLoader2, XCircle, AlertCircleï¼‰
- `@radix-ui/*` - UI å…ƒä»¶åŸºç¤

---

## ğŸ§ª æ¸¬è©¦æª¢æŸ¥æ¸…å–®

### å¾Œç«¯æ¸¬è©¦

- [ ] Webhook èƒ½æ¥æ”¶ LINE åœ–ç‰‡äº‹ä»¶
- [ ] åœ–ç‰‡æˆåŠŸå¾ LINE API ä¸‹è¼‰
- [ ] ç¸®åœ–æ­£ç¢ºç”Ÿæˆï¼ˆå°ºå¯¸ â‰¤ 400px å¯¬ï¼‰
- [ ] æª”æ¡ˆæ­£ç¢ºå„²å­˜åˆ° `/data/line_images/` ç›®éŒ„
- [ ] metadata æ­£ç¢ºæ›´æ–°åˆ°è³‡æ–™åº«
- [ ] åœ–ç‰‡ API æ¬Šé™é©—è­‰æ­£å¸¸
- [ ] è·¯å¾‘éæ­·æ”»æ“Šé˜²è­·æœ‰æ•ˆ

### å‰ç«¯æ¸¬è©¦

- [ ] åœ–ç‰‡è¨Šæ¯æ­£ç¢ºæ¸²æŸ“ç¸®åœ–
- [ ] æ‡¶åŠ è¼‰åŠŸèƒ½é‹ä½œï¼ˆæ»¾å‹•æ™‚æ‰è¼‰å…¥ï¼‰
- [ ] æª”æ¡ˆå¤§å°æ¨™ç±¤æ­£ç¢ºé¡¯ç¤º
- [ ] é»æ“Šç¸®åœ–é–‹å•Ÿ Lightbox
- [ ] Lightbox é¡¯ç¤ºé«˜è§£æåº¦åŸåœ–
- [ ] ESC éµé—œé–‰ Lightbox
- [ ] èƒŒæ™¯é»æ“Šé—œé–‰ Lightbox
- [ ] è™•ç†ä¸­ç‹€æ…‹æ­£ç¢ºé¡¯ç¤º
- [ ] éŒ¯èª¤è¨Šæ¯æ­£ç¢ºé¡¯ç¤º

### æ•´åˆæ¸¬è©¦

- [ ] ç«¯åˆ°ç«¯æµç¨‹ï¼šLINE å‚³åœ– â†’ é¡¯ç¤ºåœ¨å‰ç«¯
- [ ] å¤šçµ„ç¹”éš”é›¢ï¼ˆç„¡æ³•å­˜å–å…¶ä»–çµ„ç¹”åœ–ç‰‡ï¼‰
- [ ] å¤§åœ–ç‰‡è™•ç†ï¼ˆæ¸¬è©¦ 10MB+ åœ–ç‰‡ï¼‰
- [ ] éŒ¯èª¤è™•ç†ï¼ˆç¶²è·¯å¤±æ•—ã€ç„¡æ•ˆåœ–ç‰‡ï¼‰

---

## ğŸš€ éƒ¨ç½²æ³¨æ„äº‹é …

### ç’°å¢ƒè¦æ±‚

- **Node.js**: >= 16.xï¼ˆæ”¯æ´ Sharpï¼‰
- **ç£ç¢Ÿç©ºé–“**: å»ºè­°é ç•™è‡³å°‘ 10GBï¼ˆåœ–ç‰‡å„²å­˜ï¼‰
- **è¨˜æ†¶é«”**: å»ºè­°è‡³å°‘ 512MBï¼ˆSharp åœ–ç‰‡è™•ç†ï¼‰

### ç›®éŒ„æ¬Šé™

ç¢ºä¿ `/data/line_images/` ç›®éŒ„æœ‰å¯«å…¥æ¬Šé™ï¼š

```bash
mkdir -p data/line_images
chmod 755 data/line_images
```

### ç’°å¢ƒè®Šæ•¸ï¼ˆå¯é¸ï¼‰

```bash
# è‡ªè¨‚åœ–ç‰‡å„²å­˜è·¯å¾‘ï¼ˆé è¨­ï¼š{project}/data/line_imagesï¼‰
IMAGE_STORAGE_PATH=/custom/path/to/images
```

---

## ğŸ“Š æ•ˆèƒ½æŒ‡æ¨™

### é æœŸæ•ˆæœ

- **ç¸®åœ–å¤§å°**: 100-200KBï¼ˆç›¸æ¯”åŸåœ– 2-5MBï¼Œç¯€çœ 85-95%ï¼‰
- **è¼‰å…¥é€Ÿåº¦**: ç¸®åœ–è¼‰å…¥æ™‚é–“ < 500ms
- **è™•ç†æ™‚é–“**: å–®å¼µåœ–ç‰‡è™•ç†æ™‚é–“ < 2 ç§’
- **é »å¯¬ç¯€çœ**: èŠå¤©åˆ—è¡¨æµé‡æ¸›å°‘ 70-90%

### ç›£æ§å»ºè­°

- è¿½è¹¤åœ–ç‰‡è™•ç†å¤±æ•—ç‡
- ç›£æ§ç£ç¢Ÿä½¿ç”¨é‡
- è¨˜éŒ„å¹³å‡è™•ç†æ™‚é–“

---

## ğŸ”® æœªä¾†æ“´å±•å»ºè­°

### çŸ­æœŸï¼ˆ1-2 å€‹æœˆï¼‰

1. **åœ–ç‰‡ç™¼é€åŠŸèƒ½**: ç®¡ç†å“¡ä¸Šå‚³åœ–ç‰‡å‚³çµ¦ç—…æ‚£
2. **æ‰¹é‡ä¸‹è¼‰**: ä¸‹è¼‰å°è©±ä¸­æ‰€æœ‰åœ–ç‰‡
3. **åœ–ç‰‡é è¦½å„ªåŒ–**: æ”¯æ´åœ–ç‰‡ç¸®æ”¾ï¼ˆæ»‘é¼ æ»¾è¼ªï¼‰

### ä¸­æœŸï¼ˆ3-6 å€‹æœˆï¼‰

1. **é›²ç«¯å„²å­˜**: é·ç§»è‡³ AWS S3 / CloudFlare R2
2. **CDN åŠ é€Ÿ**: ä½¿ç”¨ CDN åŠ å¿«åœ–ç‰‡è¼‰å…¥
3. **åœ–ç‰‡å£“ç¸®å„ªåŒ–**: ä½¿ç”¨ WebP æ ¼å¼ï¼ˆæ›´å°æª”æ¡ˆï¼‰

### é•·æœŸï¼ˆ6-12 å€‹æœˆï¼‰

1. **å½±ç‰‡è¨Šæ¯**: æ”¯æ´å½±ç‰‡æ¥æ”¶å’Œæ’­æ”¾
2. **åœ–ç‰‡ OCR**: è‡ªå‹•è¾¨è­˜åœ–ç‰‡ä¸­çš„æ–‡å­—
3. **AI åœ–ç‰‡åˆ†é¡**: è‡ªå‹•åˆ†é¡ç—…æ­·ç…§ã€æª¢æŸ¥å ±å‘Šç­‰

---

## âœ… å®Œæˆç¢ºèª

- [x] æ‰€æœ‰ 5 å€‹éšæ®µå¯¦ä½œå®Œæˆ
- [x] å‰ç«¯ç·¨è­¯æˆåŠŸï¼ˆç„¡éŒ¯èª¤ï¼‰
- [x] å¾Œç«¯ API ç«¯é»å»ºç«‹
- [x] å®‰å…¨æ©Ÿåˆ¶å¯¦ä½œ
- [x] æ–‡ä»¶æ’°å¯«å®Œæˆ

---

## ğŸ“ ç›¸é—œæ–‡ä»¶

- [å¯¦ä½œè¨ˆåŠƒ](./LINE_IMAGE_ENHANCEMENT_PLAN.md) - è©³ç´°çš„å¯¦ä½œè¦åŠƒ
- [è³‡æ–™åº«æ¶æ§‹](./DATABASE_SCHEMA.md) - è³‡æ–™åº«æ¬„ä½èªªæ˜
- [LINE API æ–‡ä»¶](https://developers.line.biz/en/docs/messaging-api/) - LINE å®˜æ–¹æ–‡ä»¶

---

## ğŸ‰ ç¸½çµ

æˆåŠŸå¯¦ä½œäº†å®Œæ•´çš„ LINE åœ–ç‰‡è¨Šæ¯åŠŸèƒ½ï¼ŒåŒ…å«ï¼š

1. âœ… **å¾Œç«¯è™•ç†**: Webhookã€ä¸‹è¼‰ã€å£“ç¸®ã€å„²å­˜
2. âœ… **å‰ç«¯æ¸²æŸ“**: æ‡¶åŠ è¼‰ã€ç¸®åœ–ã€Lightbox
3. âœ… **å®‰å…¨æ©Ÿåˆ¶**: æ¬Šé™é©—è­‰ã€è·¯å¾‘é˜²è­·
4. âœ… **ä½¿ç”¨è€…é«”é©—**: æµæš¢è¼‰å…¥ã€æ”¾å¤§æŸ¥çœ‹
5. âœ… **æ•ˆèƒ½å„ªåŒ–**: ç¸®åœ–ç­–ç•¥ã€å¿«å–æ©Ÿåˆ¶

æ‰€æœ‰åŠŸèƒ½å·²å®Œæˆä¸¦é€šéç·¨è­¯æ¸¬è©¦ï¼Œå¯ä»¥é–‹å§‹å¯¦éš›æ¸¬è©¦å’Œéƒ¨ç½²ã€‚

---

**å¯¦ä½œè€…**: Claude Code AI
**å¯©æ ¸è€…**: _å¾…å¡«å¯«_
**ä¸Šç·šæ—¥æœŸ**: _å¾…å¡«å¯«_
