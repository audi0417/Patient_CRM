# 患者管理系統 - 登入與權限管理說明

## 概述

本系統已整合完整的使用者認證與權限管理功能,提供安全的多使用者協作環境。所有使用者共用同一個資料庫,管理同一醫院的病患資料。

## 功能特色

### 🔐 安全認證
- **密碼加密**: 使用 bcrypt 進行密碼雜湊,確保密碼安全
- **JWT Token**: 使用 JSON Web Token 管理使用者會話
- **密碼規則**: 強制要求密碼長度至少 8 字元,包含大小寫字母及數字
- **自動登出**: Token 過期後自動登出
- **路由保護**: 未登入使用者無法存取系統功能

### 👥 角色與權限

系統提供三種使用者角色,各有不同權限:

#### 1. 超級管理員 (Super Admin)
- ✅ 查看、編輯、刪除患者資料
- ✅ 查看、編輯健康記錄
- ✅ 管理預約
- ✅ 管理使用者帳號
- ✅ 存取系統設定
- ✅ 匯出資料
- ✅ 管理醫院設定

#### 2. 管理員 (Admin)
- ✅ 查看、編輯、刪除患者資料
- ✅ 查看、編輯健康記錄
- ✅ 管理預約
- ✅ 管理使用者帳號
- ✅ 存取系統設定
- ✅ 匯出資料
- ❌ 管理醫院設定

#### 3. 一般使用者 (User)
- ✅ 查看、編輯患者資料
- ✅ 查看、編輯健康記錄
- ✅ 管理預約
- ✅ 匯出資料
- ❌ 刪除患者
- ❌ 管理使用者
- ❌ 存取系統設定

## 首次使用設定

### 步驟 1: 建立超級管理員帳號

第一次啟動系統時,會自動導向初始設定頁面:

1. 開啟應用程式
2. 系統自動偵測到沒有使用者
3. 導向到 `/setup` 頁面
4. 填寫超級管理員資訊:
   - 姓名
   - Email
   - 使用者名稱
   - 密碼(至少 8 字元,含大小寫字母及數字)
5. 點擊「建立超級管理員帳號」

### 步驟 2: 登入系統

1. 建立完成後自動導向登入頁面
2. 輸入剛才設定的使用者名稱和密碼
3. 點擊「登入」

### 步驟 3: 新增使用者

超級管理員或管理員可以新增其他使用者:

1. 登入後點擊頂部導航列的「使用者管理」
2. 點擊「新增使用者」按鈕
3. 填寫使用者資訊:
   - 姓名
   - Email
   - 使用者名稱
   - 密碼
   - 角色(選擇適當的角色)
   - 帳號狀態(啟用/停用)
4. 點擊「建立」

## 使用者管理功能

### 編輯使用者
- 修改使用者基本資訊
- 變更使用者角色
- 啟用或停用帳號

### 重設密碼
- 管理員可以為其他使用者重設密碼
- 需設定符合密碼規則的新密碼

### 刪除使用者
- 只能刪除非當前登入的使用者
- 無法刪除最後一個超級管理員(系統保護)

## 安全性考量

### 密碼安全
- 密碼使用 bcrypt 加密,鹽值輪數為 10
- 密碼不以明文儲存
- 密碼傳輸時經過加密處理

### 會話管理
- JWT Token 有效期為 24 小時
- Token 儲存在 localStorage
- 每次請求驗證 Token 有效性
- Token 過期後自動登出

### 權限控制
- 路由層級的權限保護
- 根據角色自動顯示/隱藏功能
- API 層級的權限驗證(未來擴充)

## 技術架構

### 前端
- **認證 Context**: `src/contexts/AuthContext.tsx`
- **使用者類型**: `src/types/user.ts`
- **認證邏輯**: `src/lib/auth.ts`
- **保護路由**: `src/components/ProtectedRoute.tsx`
- **登入頁面**: `src/pages/Login.tsx`
- **初始設定**: `src/pages/InitialSetup.tsx`
- **使用者管理**: `src/pages/UserManagement.tsx`

### 資料儲存
- 使用 localStorage 儲存使用者資料
- 使用者資料 key: `hospital_crm_users`
- Token key: `hospital_crm_auth_token`
- 當前使用者 key: `hospital_crm_current_user`

### 密碼學
- **bcryptjs**: 密碼加密
- **jsonwebtoken**: JWT Token 生成與驗證

## 常見問題

### Q: 忘記密碼怎麼辦?
A: 請聯絡系統管理員(Super Admin 或 Admin)為您重設密碼。

### Q: 如何變更自己的密碼?
A: 目前需要聯絡管理員協助變更。未來版本將加入使用者自行變更密碼的功能。

### Q: 可以有多個超級管理員嗎?
A: 可以。Super Admin 可以建立其他 Super Admin 帳號。

### Q: 刪除使用者會影響病患資料嗎?
A: 不會。病患資料獨立於使用者資料,刪除使用者不會影響病患記錄。

### Q: 系統支援多院區嗎?
A: 目前版本為單院區設計。多院區功能需要進一步的資料庫架構調整。

## 開發說明

### 新增角色權限

1. 在 `src/types/user.ts` 中定義新角色
2. 在 `ROLE_PERMISSIONS` 中設定權限
3. 在 `ROLE_LABELS` 中設定顯示名稱

### 新增權限檢查

```typescript
import { useAuth } from "@/contexts/AuthContext";

const MyComponent = () => {
  const { permissions } = useAuth();

  if (!permissions?.canEditPatients) {
    return <div>您沒有權限編輯患者資料</div>;
  }

  // ... 元件內容
};
```

### 保護路由

```typescript
<Route
  path="/sensitive-page"
  element={
    <ProtectedRoute requiredRoles={["super_admin", "admin"]}>
      <ProtectedLayout>
        <SensitivePage />
      </ProtectedLayout>
    </ProtectedRoute>
  }
/>
```

## 未來改進方向

- [ ] 使用者自行修改密碼功能
- [ ] 登入記錄與審計日誌
- [ ] 兩步驟驗證(2FA)
- [ ] 密碼過期政策
- [ ] IP 白名單限制
- [ ] 多院區支援
- [ ] LDAP/Active Directory 整合
- [ ] 使用者操作記錄
- [ ] 更細緻的權限控制(如特定患者存取權限)

## 技術支援

如有問題或建議,請聯絡開發團隊。

---

**版本**: 1.0.0
**最後更新**: 2025-01-05
