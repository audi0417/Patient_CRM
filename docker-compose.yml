version: '3.8'

services:
  # PostgreSQL 資料庫
  db:
    image: postgres:15-alpine
    container_name: patient-crm-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DATABASE_USER:-postgres}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD:-postgres}
      POSTGRES_DB: ${DATABASE_NAME:-patient_crm}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # 初始化腳本（如需要）
      - ./server/database/rls-policies.sql:/docker-entrypoint-initdb.d/01-rls-policies.sql:ro
    ports:
      - "${DATABASE_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DATABASE_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - patient-crm-network

  # Patient CRM 應用程式
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        DEPLOYMENT_MODE: ${DEPLOYMENT_MODE:-saas}
        APP_VERSION: ${APP_VERSION:-1.0.0}
        BUILD_DATE: ${BUILD_DATE}
        VCS_REF: ${VCS_REF}
    container_name: patient-crm-app
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      # 伺服器配置
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${PORT:-3001}

      # 部署模式
      DEPLOYMENT_MODE: ${DEPLOYMENT_MODE:-saas}
      APP_VERSION: ${APP_VERSION:-1.0.0}

      # 資料庫配置（PostgreSQL）
      DATABASE_TYPE: postgres
      DATABASE_HOST: db
      DATABASE_PORT: 5432
      DATABASE_USER: ${DATABASE_USER:-postgres}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD:-postgres}
      DATABASE_NAME: ${DATABASE_NAME:-patient_crm}

      # 安全配置
      JWT_SECRET: ${JWT_SECRET}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
      SUPER_ADMIN_PASSWORD: ${SUPER_ADMIN_PASSWORD:-SuperAdmin@2024}

      # CORS 配置
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost:3001,http://localhost:5173}
      API_ENDPOINT: ${API_ENDPOINT:-http://localhost:3001}
      CLIENT_URL: ${CLIENT_URL:-http://localhost:5173}

      # License（地端模式）
      # LICENSE_KEY: ${LICENSE_KEY}
      # LICENSE_PUBLIC_KEY_PATH: ${LICENSE_PUBLIC_KEY_PATH:-config/license-public.pem}

      # 郵件服務（可選）
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      SMTP_FROM: ${SMTP_FROM}

      # 功能開關
      ENABLE_EMAIL_NOTIFICATIONS: ${ENABLE_EMAIL_NOTIFICATIONS:-false}
      ENABLE_SMS_NOTIFICATIONS: ${ENABLE_SMS_NOTIFICATIONS:-false}
      ENABLE_BACKUP: ${ENABLE_BACKUP:-true}

      # 日誌
      LOG_LEVEL: ${LOG_LEVEL:-info}

    ports:
      - "${PORT:-3001}:3001"

    volumes:
      # SQLite 資料（如果使用 SQLite 模式）
      - app_data:/app/data
      # License key（地端模式）
      # - ./config/license-private.pem:/app/config/license-private.pem:ro
      # 日誌
      - app_logs:/app/logs

    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/api/health-check', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    networks:
      - patient-crm-network

volumes:
  postgres_data:
    driver: local
  app_data:
    driver: local
  app_logs:
    driver: local

networks:
  patient-crm-network:
    driver: bridge
