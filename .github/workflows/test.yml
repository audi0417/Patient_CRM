name: Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Test Application
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x]

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: patient_crm_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint code
        run: npm run lint --if-present
        continue-on-error: true

      - name: Build frontend
        run: npm run build
        env:
          NODE_ENV: production

      - name: Verify build artifacts
        run: |
          if [ ! -d "dist" ]; then
            echo "Error: dist directory not found"
            exit 1
          fi
          echo "✓ Frontend build successful"

      - name: Run tests
        run: npm test --if-present
        env:
          NODE_ENV: test
          DATABASE_TYPE: postgres
          DATABASE_HOST: localhost
          DATABASE_PORT: 5432
          DATABASE_USER: postgres
          DATABASE_PASSWORD: postgres
          DATABASE_NAME: patient_crm_test
          JWT_SECRET: test_jwt_secret_for_ci_pipeline_minimum_32_characters
          ENCRYPTION_KEY: test_encryption_key_for_ci_minimum_32_chars

      - name: Test server startup (PostgreSQL)
        run: |
          # Create test script
          cat > test-server.js << 'EOF'
          process.env.NODE_ENV = 'test';
          process.env.DATABASE_TYPE = 'postgres';
          process.env.DATABASE_HOST = 'localhost';
          process.env.DATABASE_PORT = '5432';
          process.env.DATABASE_USER = 'postgres';
          process.env.DATABASE_PASSWORD = 'postgres';
          process.env.DATABASE_NAME = 'patient_crm_test';
          process.env.JWT_SECRET = 'test_jwt_secret_for_ci_pipeline_minimum_32_characters';
          process.env.ENCRYPTION_KEY = 'test_encryption_key_for_ci_minimum_32_chars';
          process.env.DEPLOYMENT_MODE = 'saas';

          console.log('Testing server modules...');

          try {
            // Test database connection
            const { dbAdapter } = require('./server/database/db');
            console.log('✓ Database module loaded');

            // Test SQL helpers
            const sqlHelpers = require('./server/database/sqlHelpers');
            console.log('✓ SQL helpers loaded');
            console.log('  Database type:', sqlHelpers.getDbType());

            // Test deployment config
            const deployment = require('./server/config/deployment');
            console.log('✓ Deployment config loaded');
            console.log('  Mode:', deployment.getDeploymentMode());

            // Test routes (load without starting server)
            require('./server/routes/auth');
            console.log('✓ Auth routes loaded');

            require('./server/routes/patients');
            console.log('✓ Patients routes loaded');

            console.log('\n✅ All server modules loaded successfully');
            process.exit(0);
          } catch (error) {
            console.error('\n❌ Server module test failed:');
            console.error(error.message);
            process.exit(1);
          }
          EOF

          # Run test
          node test-server.js

          # Cleanup
          rm test-server.js

      - name: Test server startup (SQLite)
        run: |
          # Create test script for SQLite mode
          cat > test-server-sqlite.js << 'EOF'
          process.env.NODE_ENV = 'test';
          process.env.DATABASE_TYPE = 'sqlite';
          process.env.DATABASE_PATH = ':memory:';
          process.env.JWT_SECRET = 'test_jwt_secret_for_ci_pipeline_minimum_32_characters';
          process.env.ENCRYPTION_KEY = 'test_encryption_key_for_ci_minimum_32_chars';
          process.env.DEPLOYMENT_MODE = 'saas';

          console.log('Testing server in SQLite mode...');

          try {
            const sqlHelpers = require('./server/database/sqlHelpers');
            console.log('✓ SQL helpers loaded');
            console.log('  Database type:', sqlHelpers.getDbType());

            const deployment = require('./server/config/deployment');
            console.log('✓ Deployment config loaded');

            console.log('\n✅ SQLite mode test passed');
            process.exit(0);
          } catch (error) {
            console.error('\n❌ SQLite mode test failed:');
            console.error(error.message);
            process.exit(1);
          }
          EOF

          node test-server-sqlite.js
          rm test-server-sqlite.js

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/
          retention-days: 7

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: test
    if: always()

    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "✅ All tests passed"
          else
            echo "❌ Tests failed"
            exit 1
          fi
